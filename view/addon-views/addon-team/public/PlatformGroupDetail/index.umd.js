(function(e,y){typeof exports=="object"&&typeof module<"u"?module.exports=y(require("vue"),require("element-plus"),require("@/composables/useConvert"),require("@/apis/good"),require("@/utils/http"),require("decimal.js"),require("vue-router")):typeof define=="function"&&define.amd?define(["vue","element-plus","@/composables/useConvert","@/apis/good","@/utils/http","decimal.js","vue-router"],y):(e=typeof globalThis<"u"?globalThis:e||self,e.PlatformGroupDetail=y(e.PlatformGroupDetailContext.Vue,e.PlatformGroupDetailContext.ElementPlus,e.PlatformGroupDetailContext.UseConvert,e.PlatformGroupDetailContext.GoodAPI,e.PlatformGroupDetailContext.UtilsHttp,e.PlatformGroupDetailContext.Decimal,e.PlatformGroupDetailContext.VueRouter))})(this,function(e,y,O,$,G,te,P){"use strict";var D=document.createElement("style");D.textContent=`@charset "UTF-8";.com[data-v-3f7e4e07]{display:flex;justify-content:center;align-items:center}.com__pic[data-v-3f7e4e07]{width:62px;height:62px}.com__name[data-v-3f7e4e07]{width:113px;font-size:14px;color:#333;margin-left:10px;display:flex;flex-direction:column;align-items:baseline}.com__name--text[data-v-3f7e4e07]{display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;overflow:hidden}.flex[data-v-3f7e4e07]{display:flex;justify-content:space-between;align-items:center}.groupForm[data-v-125d8c13]{padding:30px 16px 10px;overflow:scroll}.groupForm__title[data-v-125d8c13]{font-size:14px;color:#606266;font-weight:700;margin-bottom:30px}.groupForm__stairs[data-v-125d8c13]{margin-bottom:16px}.groupForm__stairs--title[data-v-125d8c13]{font-size:12px;color:#333;font-weight:700}.groupForm__stairs--input[data-v-125d8c13]{margin:0 7px}.groupForm__btn[data-v-125d8c13]{width:1010px;position:fixed;left:292px;bottom:10px;height:60px;display:flex;justify-content:center;align-items:center;box-shadow:0 0 10px #d5d5d5;background-color:#fff;z-index:999;margin:0 auto}.tips[data-v-125d8c13]{font-size:12px;color:#c4c4c4}.nav-button[data-v-125d8c13]{margin-top:auto;align-items:center;position:sticky;bottom:0;padding:15px 0;display:flex;justify-content:center;box-shadow:0 0 10px #d5d5d5;background-color:#fff;z-index:9}
`,document.head.appendChild(D);const q={class:"com"},A={class:"com__name"},R={class:"com__name--text",style:{"margin-top":"5px"}},L={class:"flex"},j={key:0},z={class:"dialog-footer"},J=e.defineComponent({__name:"select-good-table",props:{mode:{type:String,default:"COMMON"},users:{type:Array,default(){return[]}},productList:{type:Array,default(){return[]}},isEdit:{type:Boolean,default:!1},flatGoodList:{type:Array,default(){return[]}}},setup(h,{expose:g}){const i=h,{divTenThousand:r,mulTenThousand:I}=O(),N=e.ref([]);e.watch(()=>i.productList,t=>{const l=T(t);if((l==null?void 0:l.length)===0)return y.ElMessage.error("请至少选择一个存在库存的商品");N.value=o(l)},{deep:!0}),e.watch(()=>i.flatGoodList,t=>{N.value=o(t)});function w(t){return t.skuItem.stockType==="LIMITED"?Number(t.skuItem.skuStock):1e5}function x(t){return r(t.skuItem.skuPrice).toNumber()}function T(t,l){if(!t.length)return[];const m=[];return t.forEach(d=>{d.skuIds.forEach((p,n)=>{(d.stocks[n]>0&&d.stockTypes[n]==="LIMITED"||d.stockTypes[n]==="UNLIMITED")&&m.push({productId:d.productId,productName:d.productName,productPic:d.pic,skuItem:{productId:d.productId,skuId:p,skuName:d.specs[n]?d.specs[n]:"",skuPrice:d.salePrices[n],skuStock:d.stocks[n]?d.stocks[n]:"",stockType:d.stockTypes[n]},rowTag:0,stock:+d.stocks[n],prices:[d.salePrices[n]],isJoin:d.stocks[n]>0})})}),m}function o(t,l){let m=0,d=t.length;for(let p=0;p<d;p++){const n=t[p];p===0&&(n.rowTag=1,m=0),p!==0&&(n.productId===t[p-1].productId?(n.rowTag=0,t[m].rowTag=t[m].rowTag+1):(n.rowTag=1,m=p)),n.prices=n.prices.map(C=>+C),n.stock=+n.stock}return t}const b=({row:t,column:l,rowIndex:m,columnIndex:d})=>{if(d===0)return{rowspan:t.rowTag,colspan:t.rowTag?1:0}};function u(t){return t.stockType==="UNLIMITED"?"无限库存":`${"库存"+t.skuStock||0}`}function E(){const t=e.toRaw(N.value),l=[],m=new Map;if(t.length)for(let d=0;d<t.length;d++){if(!t[d].isJoin)continue;const p=t[d],n=p.productId,C={skuId:p.skuItem.skuId,stock:+p.stock,prices:p.prices.map(S=>I(S).toNumber())};if(!m.has(n))m.set(n,l.length),l.push({productId:n,skus:[C]});else{const S=m.get(n);l[S].skus.push(C)}}return l}function V(){let t=!0;const l=N.value;if(!l.length)y.ElMessage.warning("请选择商品"),t=!1;else for(let m=0;m<l.length;m++)if(l[m].isJoin){if(!l[m].stock){y.ElMessage.warning("商品库存必须大于零"),t=!1;break}if(l[m].prices.length!==i.users.length||l[m].prices.some(d=>d===null)){y.ElMessage.warning("拼团价格填写完整"),t=!1;break}}return t}const c=e.ref({stock:1,price:[.01]}),k=e.ref(!1),_=e.ref("0"),U=t=>{_.value=t.productId,c.value.stock=t.skuItem.skuStock,k.value=!0},M=()=>{c.value={stock:1,price:[.01]},k.value=!1},s=()=>{i.mode==="COMMON"?N.value.forEach(t=>{t.productId===_.value&&(t.stock=c.value.stock>w(t)?w(t):c.value.stock,t.prices[0]=c.value.price[0]>x(t)?x(t):c.value.price[0])}):N.value.forEach(t=>{if(t.productId===_.value){t.stock=c.value.stock>w(t)?w(t):c.value.stock;for(let l=0;l<i.users.length;l++)t.prices[l]=c.value.price[l]>x(t)?x(t):c.value.price[l]}}),k.value=!1},B=(t,l)=>typeof t=="string"?t:t.length===1?t[0]:t[l];return g({getProduct:E,validateProduct:V}),(t,l)=>{const m=e.resolveComponent("el-image"),d=e.resolveComponent("el-button"),p=e.resolveComponent("el-table-column"),n=e.resolveComponent("el-input-number"),C=e.resolveComponent("el-input"),S=e.resolveComponent("el-table"),v=e.resolveComponent("el-dialog");return e.openBlock(),e.createElementBlock(e.Fragment,null,[e.createVNode(S,{data:N.value,"span-method":b},{default:e.withCtx(()=>[e.createVNode(p,{label:"商品信息",width:"215"},{default:e.withCtx(({row:a})=>[e.createElementVNode("div",q,[e.createVNode(m,{src:a.productPic,class:"com__pic"},null,8,["src"]),e.createElementVNode("div",A,[i.isEdit?e.createCommentVNode("",!0):(e.openBlock(),e.createBlock(d,{key:0,class:"com__batch",type:"primary",link:"",onClick:f=>U(a)},{default:e.withCtx(()=>l[4]||(l[4]=[e.createTextVNode(" 批量设置 ")])),_:2},1032,["onClick"])),e.createElementVNode("span",R,e.toDisplayString(a.productName),1)])])]),_:1}),e.createVNode(p,{label:"规格"},{default:e.withCtx(({row:a,$index:f})=>[e.createTextVNode(e.toDisplayString(B(a.skuItem.skuName,f)),1)]),_:1}),e.createVNode(p,{label:"库存"},{default:e.withCtx(({row:a})=>[e.createElementVNode("div",null,[e.createVNode(n,{modelValue:a.stock,"onUpdate:modelValue":f=>a.stock=f,min:0,style:{width:"80px"},max:w(a),disabled:i.isEdit,precision:0,controls:!1},null,8,["modelValue","onUpdate:modelValue","max","disabled"])]),e.createElementVNode("div",null,e.toDisplayString(u(a.skuItem)),1)]),_:1}),i.mode==="COMMON"?(e.openBlock(),e.createBlock(p,{key:0,label:"拼团价"},{default:e.withCtx(({row:a})=>[e.createElementVNode("div",null,[i.isEdit?(e.openBlock(),e.createBlock(C,{key:0,style:{width:"80px"},disabled:"",placeholder:e.unref(r)(a.prices[0]).toString()},null,8,["placeholder"])):(e.openBlock(),e.createBlock(n,{key:1,modelValue:a.prices[0],"onUpdate:modelValue":f=>a.prices[0]=f,min:.01,style:{width:"80px"},disabled:i.isEdit,precision:2,max:x(a),controls:!1},null,8,["modelValue","onUpdate:modelValue","disabled","max"]))]),e.createElementVNode("div",null,"销售价"+e.toDisplayString(e.unref(r)(a.skuItem.skuPrice)),1)]),_:1})):e.createCommentVNode("",!0),i.mode==="STAIRS"&&i.users.length>0?(e.openBlock(),e.createBlock(p,{key:1,label:"第一阶段拼团"},{default:e.withCtx(({row:a})=>[e.createElementVNode("div",null,[i.isEdit?(e.openBlock(),e.createBlock(C,{key:0,style:{width:"80px"},disabled:"",placeholder:e.unref(r)(a.prices[0]).toString()},null,8,["placeholder"])):(e.openBlock(),e.createBlock(n,{key:1,modelValue:a.prices[0],"onUpdate:modelValue":f=>a.prices[0]=f,min:.01,style:{width:"80px"},disabled:i.isEdit,precision:2,max:x(a),controls:!1},null,8,["modelValue","onUpdate:modelValue","disabled","max"]))]),e.createElementVNode("div",null,"销售价"+e.toDisplayString(e.unref(r)(a.skuItem.skuPrice)),1)]),_:1})):e.createCommentVNode("",!0),i.mode==="STAIRS"&&i.users.length>1?(e.openBlock(),e.createBlock(p,{key:2,label:"第二阶段拼团"},{default:e.withCtx(({row:a})=>[e.createElementVNode("div",null,[i.isEdit?(e.openBlock(),e.createBlock(C,{key:0,style:{width:"80px"},disabled:"",placeholder:e.unref(r)(a.prices[1]).toString()},null,8,["placeholder"])):(e.openBlock(),e.createBlock(n,{key:1,modelValue:a.prices[1],"onUpdate:modelValue":f=>a.prices[1]=f,disabled:i.isEdit,min:.01,style:{width:"80px"},max:x(a),precision:2,controls:!1},null,8,["modelValue","onUpdate:modelValue","disabled","max"]))]),e.createElementVNode("div",null,"销售价"+e.toDisplayString(x(a)),1)]),_:1})):e.createCommentVNode("",!0),i.mode==="STAIRS"&&i.users.length>2?(e.openBlock(),e.createBlock(p,{key:3,label:"第三阶段拼团"},{default:e.withCtx(({row:a})=>[e.createElementVNode("div",null,[i.isEdit?(e.openBlock(),e.createBlock(C,{key:0,style:{width:"80px"},disabled:"",placeholder:e.unref(r)(a.prices[2]).toString()},null,8,["placeholder"])):(e.openBlock(),e.createBlock(n,{key:1,modelValue:a.prices[2],"onUpdate:modelValue":f=>a.prices[2]=f,disabled:i.isEdit,min:.01,style:{width:"80px"},precision:2,max:x(a),controls:!1},null,8,["modelValue","onUpdate:modelValue","disabled","max"]))]),e.createElementVNode("div",null,"销售价"+e.toDisplayString(x(a)),1)]),_:1})):e.createCommentVNode("",!0)]),_:1},8,["data"]),e.createVNode(v,{modelValue:k.value,"onUpdate:modelValue":l[3]||(l[3]=a=>k.value=a),title:"批量设置","destroy-on-close":"",center:"",width:i.mode==="COMMON"?500:"50%",top:"30vh",onClose:M},{footer:e.withCtx(()=>[e.createElementVNode("div",z,[e.createVNode(d,{onClick:l[2]||(l[2]=a=>k.value=!1)},{default:e.withCtx(()=>l[7]||(l[7]=[e.createTextVNode("取消")])),_:1}),e.createVNode(d,{type:"primary",onClick:s},{default:e.withCtx(()=>l[8]||(l[8]=[e.createTextVNode(" 确定 ")])),_:1})])]),default:e.withCtx(()=>[e.createElementVNode("div",L,[e.createElementVNode("div",null,[l[5]||(l[5]=e.createTextVNode(" 库存 ")),e.createVNode(n,{modelValue:c.value.stock,"onUpdate:modelValue":l[0]||(l[0]=a=>c.value.stock=a),controls:!1,style:e.normalizeStyle({width:i.mode==="COMMON"?"150px":"80px"}),min:0,precision:0},null,8,["modelValue","style"])]),i.mode==="COMMON"?(e.openBlock(),e.createElementBlock("div",j,[l[6]||(l[6]=e.createTextVNode(" 拼团价 ")),e.createVNode(n,{modelValue:c.value.price[0],"onUpdate:modelValue":l[1]||(l[1]=a=>c.value.price[0]=a),precision:2,controls:!1,min:.01},null,8,["modelValue"])])):(e.openBlock(!0),e.createElementBlock(e.Fragment,{key:1},e.renderList(i.users,(a,f)=>(e.openBlock(),e.createElementBlock("div",{key:f},[e.createTextVNode(" 第"+e.toDisplayString(f+1)+"阶段拼团 ",1),e.createVNode(n,{modelValue:c.value.price[f],"onUpdate:modelValue":ee=>c.value.price[f]=ee,style:{width:"80px"},precision:2,controls:!1,min:.01},null,8,["modelValue","onUpdate:modelValue"])]))),128))])]),_:1},8,["modelValue","width"])],64)}}}),oe="",F=(h,g)=>{const i=h.__vccOpts||h;for(const[r,I]of g)i[r]=I;return i},H=F(J,[["__scopeId","data-v-3f7e4e07"]]),K=(h,g)=>G.http.get({url:`addon-team/team/activity/${g}`,params:{shopId:h}}),Q={class:"groupForm"},W={key:1},X={class:"groupForm__stairs--title"},Y={class:"nav-button"},Z=e.defineComponent({__name:"PlatformGroupDetail",setup(h){const g=P.useRoute(),i=P.useRouter(),r=e.ref({name:"",startTime:"",endTime:"",effectTimeout:0,mode:"COMMON",users:[],payTimeout:0,simulate:!1,huddle:!1,stackable:{vip:!1,coupon:!1,full:!1},products:[]}),I=e.ref([]),N=e.ref([]);w();async function w(){const T=g.query.activityId,o=g.query.shopId,{code:b,data:u}=await K(o,T);if(b!==200)return y.ElMessage.error("获取表单失败");r.value=u,N.value=[u.startTime,u.endTime],x(u)}async function x(T){const o=T.products.map(V=>V.productId),{code:b,data:u}=await $.doGetRetrieveProduct({productId:o});if(b!==200)return y.ElMessage.error("获取活动商品信息失败");let E=[];T.products.forEach(V=>{const c=u.list.find(k=>k.productId===V.productId);c&&(E=[...E,...V.skus.map((k,_)=>({productName:c.productName,productPic:c.pic,productId:c.productId,skuItem:{productId:c.productId,skuId:k.skuId,skuName:c.specs[_],skuPrice:c.salePrices[_],skuStock:c.stocks[_],stockType:c.stockTypes[_]},rowTag:0,stock:k.stock,prices:k.prices,isJoin:!0}))])}),I.value=E}return(T,o)=>{const b=e.resolveComponent("el-input"),u=e.resolveComponent("el-form-item"),E=e.resolveComponent("el-date-picker"),V=e.resolveComponent("el-radio"),c=e.resolveComponent("el-radio-group"),k=e.resolveComponent("el-input-number"),_=e.resolveComponent("el-checkbox"),U=e.resolveComponent("el-form"),M=e.resolveComponent("el-button");return e.openBlock(),e.createElementBlock(e.Fragment,null,[e.createElementVNode("div",Q,[o[24]||(o[24]=e.createElementVNode("div",{class:"groupForm__title"},"基本信息",-1)),e.createVNode(U,{ref:"ruleFormRef",model:r.value,"label-width":"110","label-position":"right",disabled:""},{default:e.withCtx(()=>[e.createVNode(u,{label:"活动名称",prop:"name"},{default:e.withCtx(()=>[e.createVNode(b,{modelValue:r.value.name,"onUpdate:modelValue":o[0]||(o[0]=s=>r.value.name=s),placeholder:"限10字",style:{width:"550px"},maxlength:"10"},null,8,["modelValue"])]),_:1}),e.createVNode(u,{label:"活动时间",prop:"startTime"},{default:e.withCtx(()=>[e.createElementVNode("div",null,[e.createVNode(E,{modelValue:N.value,"onUpdate:modelValue":o[1]||(o[1]=s=>N.value=s),style:{width:"550px"},type:"datetimerange","range-separator":"-","start-placeholder":"开始时间","end-placeholder":"结束时间"},null,8,["modelValue"])])]),_:1}),e.createVNode(u,{label:"拼团有效时间",prop:"effectTimeout",required:""},{default:e.withCtx(()=>[e.createVNode(b,{modelValue:r.value.effectTimeout,"onUpdate:modelValue":o[2]||(o[2]=s=>r.value.effectTimeout=s),formatter:s=>Number(`${s}`.replace(/[^\d]/g,"")),style:{width:"550px"}},{append:e.withCtx(()=>o[12]||(o[12]=[e.createTextVNode(" 分钟 ")])),_:1},8,["modelValue","formatter"])]),_:1}),e.createVNode(u,{label:"拼团模式",prop:"mode"},{default:e.withCtx(()=>[e.createVNode(c,{modelValue:r.value.mode,"onUpdate:modelValue":o[3]||(o[3]=s=>r.value.mode=s)},{default:e.withCtx(()=>[e.createVNode(V,{value:"COMMON"},{default:e.withCtx(()=>o[13]||(o[13]=[e.createTextVNode("普通拼团")])),_:1}),e.createVNode(V,{value:"STAIRS"},{default:e.withCtx(()=>o[14]||(o[14]=[e.createTextVNode("阶梯拼团")])),_:1})]),_:1},8,["modelValue"])]),_:1}),e.createVNode(u,{label:"参团人数",prop:"users",required:""},{default:e.withCtx(()=>[r.value.mode==="COMMON"?(e.openBlock(),e.createBlock(b,{key:0,modelValue:r.value.users[0],"onUpdate:modelValue":o[4]||(o[4]=s=>r.value.users[0]=s),formatter:s=>Number(`${s}`.replace(/[^\d]/g,"")),parser:s=>`$ ${Number(s)>=100?100:s}`,style:{width:"550px"},max:100},{append:e.withCtx(()=>o[15]||(o[15]=[e.createTextVNode(" 人 ")])),_:1},8,["modelValue","formatter","parser"])):(e.openBlock(),e.createElementBlock("div",W,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(r.value.users,(s,B)=>(e.openBlock(),e.createElementBlock("div",{key:B,class:"groupForm__stairs"},[e.createElementVNode("span",X,"第"+e.toDisplayString(B+1)+"阶段人数",1),e.createVNode(b,{modelValue:r.value.users[B],"onUpdate:modelValue":t=>r.value.users[B]=t,class:"groupForm__stairs--input",style:{width:"450px"},formatter:t=>Number(`${t}`.replace(/[^\d]/g,"")),parser:t=>`${Number(t)>=100?100:t}`,max:100},{append:e.withCtx(()=>o[16]||(o[16]=[e.createTextVNode(" 人 ")])),_:2},1032,["modelValue","onUpdate:modelValue","formatter","parser"])]))),128))]))]),_:1}),e.createVNode(u,{label:"订单关闭时间",prop:"payTimeout"},{default:e.withCtx(()=>[e.createVNode(k,{modelValue:r.value.payTimeout,"onUpdate:modelValue":o[5]||(o[5]=s=>r.value.payTimeout=s),controls:!1,max:360,min:3},null,8,["modelValue"]),o[17]||(o[17]=e.createElementVNode("span",{class:"tips",style:{"margin-left":"8px"}},"商品按下单减库存，请设置未付款订单自动取消时间及时释放库存，可输入3-360分钟",-1))]),_:1}),e.createVNode(u,{label:"模拟成团",prop:"simulate"},{default:e.withCtx(()=>[e.createElementVNode("div",null,[e.createVNode(c,{modelValue:r.value.simulate,"onUpdate:modelValue":o[6]||(o[6]=s=>r.value.simulate=s)},{default:e.withCtx(()=>[e.createVNode(V,{value:!1},{default:e.withCtx(()=>o[18]||(o[18]=[e.createTextVNode("关闭")])),_:1}),e.createVNode(V,{value:!0},{default:e.withCtx(()=>o[19]||(o[19]=[e.createTextVNode("开启")])),_:1})]),_:1},8,["modelValue"]),o[20]||(o[20]=e.createElementVNode("div",{class:"tips"}," 开启模拟成团后，拼团有效期内人数未满的团，系统将会以“虚拟用户”凑满人数，使该团拼团成功。你只需要对已付款参团的真实买家发货。建议合理开启，以提高成团率。 ",-1))])]),_:1}),e.createVNode(u,{label:"凑团模式",prop:"huddle"},{default:e.withCtx(()=>[e.createElementVNode("div",null,[e.createVNode(c,{modelValue:r.value.huddle,"onUpdate:modelValue":o[7]||(o[7]=s=>r.value.huddle=s)},{default:e.withCtx(()=>[e.createVNode(V,{value:!1},{default:e.withCtx(()=>o[21]||(o[21]=[e.createTextVNode("关闭")])),_:1}),e.createVNode(V,{value:!0},{default:e.withCtx(()=>o[22]||(o[22]=[e.createTextVNode("开启")])),_:1})]),_:1},8,["modelValue"]),o[23]||(o[23]=e.createElementVNode("div",{class:"tips"},"开启凑团后，活动商品详情页展示未成团的团列表，买家可以任选一个团参团，提升成团率。",-1))])]),_:1}),e.createVNode(u,{label:"优惠叠加"},{default:e.withCtx(()=>[e.createVNode(_,{modelValue:r.value.stackable.vip,"onUpdate:modelValue":o[8]||(o[8]=s=>r.value.stackable.vip=s),label:"会员价"},null,8,["modelValue"]),e.createVNode(_,{modelValue:r.value.stackable.coupon,"onUpdate:modelValue":o[9]||(o[9]=s=>r.value.stackable.coupon=s),label:"优惠券"},null,8,["modelValue"]),e.createVNode(_,{modelValue:r.value.stackable.full,"onUpdate:modelValue":o[10]||(o[10]=s=>r.value.stackable.full=s),label:"满减"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"]),e.createVNode(H,{ref:"selectGoodsTableRef",mode:r.value.mode,users:r.value.users,"is-edit":!0,"flat-good-list":I.value},null,8,["mode","users","flat-good-list"])]),e.createElementVNode("div",Y,[e.createVNode(M,{round:"",plain:"",onClick:o[11]||(o[11]=s=>e.unref(i).back())},{default:e.withCtx(()=>o[25]||(o[25]=[e.createTextVNode("返回")])),_:1})])],64)}}}),le="";return F(Z,[["__scopeId","data-v-125d8c13"]])});
