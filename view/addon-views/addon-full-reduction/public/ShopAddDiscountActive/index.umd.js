(function(e,m){typeof exports=="object"&&typeof module<"u"?module.exports=m(require("vue"),require("vue-router"),require("@/apis/http"),require("@/utils/date"),require("decimal.js"),require("@/components/q-choose-goods-popup/q-choose-goods-popup.vue"),require("element-plus"),require("@/composables/useConvert"),require("@/components/QSafeBtn/QSafeBtn.vue")):typeof define=="function"&&define.amd?define(["vue","vue-router","@/apis/http","@/utils/date","decimal.js","@/components/q-choose-goods-popup/q-choose-goods-popup.vue","element-plus","@/composables/useConvert","@/components/QSafeBtn/QSafeBtn.vue"],m):(e=typeof globalThis<"u"?globalThis:e||self,e.ShopAddDiscountActive=m(e.ShopAddDiscountActiveContext.Vue,e.ShopAddDiscountActiveContext.VueRouter,e.ShopAddDiscountActiveContext.Request,e.ShopAddDiscountActiveContext.DateUtil,e.ShopAddDiscountActiveContext.Decimal,e.ShopAddDiscountActiveContext.QChooseGoodsPopup,e.ShopAddDiscountActiveContext.ElementPlus,e.ShopAddDiscountActiveContext.UseConvert,e.ShopAddDiscountActiveContext.QSafeBtn))})(this,function(e,m,T,L,D,F,p,q,M){"use strict";var E=document.createElement("style");E.textContent=`@charset "UTF-8";.add[data-v-f903f8bf]{height:100%;position:relative;display:flex;flex-direction:column;overflow-y:scroll;padding-left:16px;padding-right:16px;padding-top:30px}.title[data-v-f903f8bf]{text-align:center;font-size:14px;color:#323233;font-weight:700;margin-bottom:30px}.msg[data-v-f903f8bf]{font-size:12px;margin-left:12px;color:#c4c4c4}.rules[data-v-f903f8bf]{display:flex;margin-top:10px;height:50px}.period-validity[data-v-f903f8bf]{width:300px;display:flex}.text[data-v-f903f8bf]{font-size:14px;color:#333}.goodsData[data-v-f903f8bf]{border:1px solid #ccc}.goods-list[data-v-f903f8bf]{width:90%;margin-top:20px;border:1px solid transparent}.goods-list__info[data-v-f903f8bf]{display:flex}.goods-list__goods-list__info-name[data-v-f903f8bf]{display:flex;flex-direction:column;justify-content:space-around;align-items:flex-start;padding:0 16px}.goods-list__goods-list__info-name--name[data-v-f903f8bf]{width:462px;font-size:14px;color:#2e99f3;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.goods-list__goods-list__info-name--price[data-v-f903f8bf]{font-size:14px;text-align:LEFT;color:#f12f22}.goods-list__goods-list__info-name--price[data-v-f903f8bf]:before{content:"￥";font-size:12px;text-align:LEFT;color:#f12f22}.my-header[data-v-f903f8bf]{font-size:16px}.ruleform-date[data-v-f903f8bf]{width:550px;display:flex;align-items:center}.flex[data-v-f903f8bf]{margin-top:10px;height:50px}.flex-item[data-v-f903f8bf]{width:40%}.coupon-rules[data-v-f903f8bf]{height:60px;display:flex;justify-content:center;align-items:center}.nav-button[data-v-f903f8bf]{position:fixed;left:50%;bottom:30px}.commodityForm[data-v-f903f8bf]{box-sizing:border-box;padding-bottom:62px}.commodityForm__tool[data-v-f903f8bf]{margin-top:auto;align-items:center;position:sticky;bottom:0;padding:15px 0;display:flex;justify-content:center;box-shadow:0 0 10px #d5d5d5;background-color:#fff;z-index:100}
`,document.head.appendChild(E);const B=[{label:"满X元减",value:"FULL_REDUCTION"},{label:"满X元折",value:"FULL_DISCOUNT"}],U="addon-full-reduction/full/reduction",O=f=>T.post({url:U,data:f}),P=f=>T.post({url:`${U}/detail`,data:f}),z={class:"add"},G={class:"title"},$={class:"ruleform-date"},j={key:0,class:"flex",style:{width:"100%",display:"flex"}},Q={key:1,class:"flex",style:{width:"100%",display:"flex"}},Y={class:"goods-list__info"},H={class:"goods-list__goods-list__info-name"},X={class:"goods-list__goods-list__info-name--name"},W={class:"commodityForm__tool"},J=e.defineComponent({__name:"ShopAddDiscountActive",setup(f){const b=m.useRouter(),g=m.useRoute(),x=new L,_=e.ref([]),N=e.reactive({form:{id:null,name:"",time:{start:"",end:""},rules:[],productType:"ALL_PRODUCT",productIds:[]},isEditDisable:!1,goodsTotal:0,fullReductionTime:[],rules:{name:[{required:!0,message:"请输入活动名称",trigger:"blur"}],"time.start":[{required:!0,message:"请选择开始日期",trigger:["blur","change"]}],"time.end":[{required:!0,message:"请选择结束日期",trigger:["blur","change"]}],productType:[{required:!0,message:"请输入满减规则",trigger:["blur","change"]}],rules:[{required:!0,message:"请添加活动规则",trigger:["blur","change"]}]},chooseGoodsPopup:!1,chooseGoodsList:[]}),{form:d,isEditDisable:i,rules:K,chooseGoodsPopup:V,chooseGoodsList:s,goodsTotal:Ve}=e.toRefs(N),u=e.ref(),{mulTenThousand:Z,divTenThousand:v}=q(),ee=o=>{!o||!o[0]||!o[1]||(o[0].getTime()>=o[1].getTime()&&p.ElMessage.warning("结束时间大于开始时间"),d.value.time.start=x.getYMDHMSs(o[0]),d.value.time.end=x.getYMDHMSs(o[1]))};te();async function te(){const o=g.query.id;if(!o)return;d.value.id=o;const{code:t,data:l,msg:a}=await P({id:o});if(t!==200){p.ElMessage.error(a||"获取活动信息失败");return}i.value=g.query.isLookUp==="true",l.rules=k(l.rules,de),_.value=[l.time.start,l.time.end],s.value=l.products.map(c=>({productId:c.id,productName:c.name,pic:c.image})),delete l.products,N.form=l}const oe=async()=>{if(i.value){R();return}if(!u.value||!await u.value.validate())return;if(!ne(d.value.rules)){p.ElMessage.error("满减规则输入有误");return}if(["SPECIFIED_PRODUCT_PARTICIPATE","SPECIFIED_PRODUCT_NOT_PARTICIPATE"].includes(d.value.productType)&&!s.value.length){p.ElMessage.error("请选择商品");return}if(d.value.rules.length===0){p.ElMessage.error("请添加活动规则");return}d.value.productIds=s.value.map(c=>c.productId);const t=k(d.value.rules,le),{code:l,msg:a}=await O({...N.form,rules:t});if(l!==200){p.ElMessage.error(a||"活动创建失败");return}p.ElMessage.success("活动创建成功"),re(),R()};function R(){b.push({name:"applyDiscountIndex"})}function ne(o){return o.every(t=>["FULL_DISCOUNT","FULL_REDUCTION"].includes(t.type)?t.type==="FULL_DISCOUNT"?t.conditionAmount&&t.discountRatio&&t.discountRatio>0&&t.discountRatio<=9.9:t.conditionAmount&&t.discountAmount&&t.conditionAmount>=t.discountAmount:!1)}function k(o,t){return o.map(l=>{const{type:a,conditionAmount:c,discountAmount:h,discountRatio:A}=l;return l.type==="FULL_DISCOUNT"?{type:a,conditionAmount:t(c),discountRatio:A}:l.type==="FULL_REDUCTION"?{type:a,conditionAmount:t(c),discountAmount:t(h)}:l})}function le(o){return o?Z(o).toNumber():0}function de(o){return o?v(o).toNumber():0}const ie=o=>{s.value=o.tempGoods},ae=async o=>{await p.ElMessageBox.confirm("确定移除该商品?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"})&&(s.value=s.value.filter(l=>l.productId!==o))};function re(){u.value&&(u.value.resetFields(),s.value=[])}const se=o=>{d.value.rules.splice(o,1)},ce=async()=>{d.value.rules.push({type:null,conditionAmount:0,discountAmount:0,discountRatio:0}),u.value&&await u.value.validate()},pe=o=>{const t=x.getYMDs(o),l=x.getYMDs(new Date);return new D(new Date(t).getTime()).lessThan(new Date(l).getTime())||new D(new Date(o).getTime()).greaterThanOrEqualTo(new Date(fe(6)).getTime())};function fe(o){let t=new Date;return t.setMonth(t.getMonth()+Number(o)),t.toLocaleString().replace(/\//g,"-")}function ue(){s.value=[]}return(o,t)=>{const l=e.resolveComponent("el-input"),a=e.resolveComponent("el-form-item"),c=e.resolveComponent("el-date-picker"),h=e.resolveComponent("el-link"),A=e.resolveComponent("el-option"),me=e.resolveComponent("el-select"),C=e.resolveComponent("el-table-column"),y=e.resolveComponent("el-input-number"),S=e.resolveComponent("el-table"),w=e.resolveComponent("el-radio"),xe=e.resolveComponent("el-radio-group"),ge=e.resolveComponent("el-image"),I=e.resolveComponent("el-button"),_e=e.resolveComponent("el-form");return e.openBlock(),e.createElementBlock(e.Fragment,null,[e.createElementVNode("div",z,[e.createElementVNode("h1",G,e.toDisplayString(e.unref(i)?"基本信息":"新增满减"),1),e.createVNode(_e,{ref_key:"ruleFormRef",ref:u,"inline-message":!1,model:e.unref(d),rules:e.unref(K),"label-width":"auto"},{default:e.withCtx(()=>[e.createVNode(a,{label:"活动名称",prop:"name"},{default:e.withCtx(()=>[e.createVNode(l,{modelValue:e.unref(d).name,"onUpdate:modelValue":t[0]||(t[0]=n=>e.unref(d).name=n),modelModifiers:{trim:!0},disabled:e.unref(i),maxlength:"10",placeholder:"请输入活动名称",style:{width:"551px"}},null,8,["modelValue","disabled"]),t[6]||(t[6]=e.createElementVNode("span",{class:"msg"},"活动名称不超过10个字",-1))]),_:1}),e.createVNode(a,{label:"活动时间",required:""},{default:e.withCtx(()=>[e.createElementVNode("div",$,[e.createVNode(c,{modelValue:_.value,"onUpdate:modelValue":t[1]||(t[1]=n=>_.value=n),type:"datetimerange","range-separator":"-","start-placeholder":"开始时间","end-placeholder":"结束时间",disabled:e.unref(i),"disabled-date":pe,onChange:ee},null,8,["modelValue","disabled"])])]),_:1}),e.createVNode(a,{"label-width":"80px",style:{"margin-bottom":"0"}},{default:e.withCtx(()=>[e.createVNode(h,{disabled:e.unref(i)||e.unref(d).rules.length>9,underline:!1,type:"primary",onClick:ce},{default:e.withCtx(()=>t[7]||(t[7]=[e.createTextVNode("添加规则 ")])),_:1},8,["disabled"]),t[8]||(t[8]=e.createElementVNode("span",{class:"msg"},"(限定10条)",-1))]),_:1}),e.createVNode(a,{label:"活动规则",prop:"rules"},{default:e.withCtx(()=>[e.createVNode(S,{"cell-style":{height:"60px"},data:e.unref(d).rules,"header-cell-style":{textAlign:"center",fontSize:"14px",color:"#606266"},border:"",style:{width:"90%"}},{default:e.withCtx(()=>[e.createVNode(C,{label:"满减条件",width:"170"},{default:e.withCtx(({row:n})=>[e.createVNode(a,{prop:"rules"},{default:e.withCtx(()=>[e.createVNode(me,{modelValue:n.type,"onUpdate:modelValue":r=>n.type=r,disabled:e.unref(i),placeholder:"全部类型"},{default:e.withCtx(()=>[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(e.unref(B),r=>(e.openBlock(),e.createBlock(A,{key:r.value,label:r.label,value:r.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","disabled"])]),_:2},1024)]),_:1}),e.createVNode(C,{label:"满减规则",width:"300"},{default:e.withCtx(({row:n})=>[n.type==="FULL_DISCOUNT"?(e.openBlock(),e.createElementBlock("div",j,[e.createVNode(a,{"label-width":"0%",prop:"conditionAmount"},{default:e.withCtx(()=>[t[9]||(t[9]=e.createElementVNode("span",null,"满",-1)),e.createVNode(y,{modelValue:n.conditionAmount,"onUpdate:modelValue":r=>n.conditionAmount=r,modelModifiers:{number:!0},controls:!1,disabled:e.unref(i),max:99999,min:1,precision:2,style:{width:"60%",margin:"0 5px"}},null,8,["modelValue","onUpdate:modelValue","disabled"]),t[10]||(t[10]=e.createElementVNode("span",null,"元,打",-1))]),_:2},1024),e.createVNode(a,{"label-width":"0%",prop:"discountRatio"},{default:e.withCtx(()=>[e.createVNode(y,{modelValue:n.discountRatio,"onUpdate:modelValue":r=>n.discountRatio=r,modelModifiers:{number:!0},controls:!1,disabled:e.unref(i),max:9.9,min:.1,precision:1,style:{width:"80%"}},null,8,["modelValue","onUpdate:modelValue","disabled"]),t[11]||(t[11]=e.createElementVNode("span",{style:{"margin-left":"5px"}},"折",-1))]),_:2},1024)])):e.createCommentVNode("",!0),n.type==="FULL_REDUCTION"?(e.openBlock(),e.createElementBlock("div",Q,[e.createVNode(a,{"label-width":0,prop:"requiredAmount"},{default:e.withCtx(()=>[t[12]||(t[12]=e.createElementVNode("span",null,"满",-1)),e.createVNode(y,{modelValue:n.conditionAmount,"onUpdate:modelValue":r=>n.conditionAmount=r,modelModifiers:{number:!0},controls:!1,disabled:e.unref(i),max:999999,min:1,precision:2,style:{width:"90px",margin:"0 5px"}},null,8,["modelValue","onUpdate:modelValue","disabled"])]),_:2},1024),e.createVNode(a,{"label-width":0,prop:"discountAmount"},{default:e.withCtx(()=>[t[13]||(t[13]=e.createElementVNode("span",null,"元,减",-1)),e.createVNode(y,{modelValue:n.discountAmount,"onUpdate:modelValue":r=>n.discountAmount=r,modelModifiers:{number:!0},controls:!1,disabled:e.unref(i),max:n.conditionAmount,min:1,precision:2,style:{width:"90px",margin:"0 5px"}},null,8,["modelValue","onUpdate:modelValue","disabled","max"]),t[14]||(t[14]=e.createElementVNode("span",{style:{"margin-left":"5px"}},"元",-1))]),_:2},1024)])):e.createCommentVNode("",!0)]),_:1}),e.createVNode(C,{align:"center",label:"操作",fixed:"right"},{default:e.withCtx(({$index:n})=>[e.createVNode(h,{disabled:e.unref(i),underline:!1,type:"danger",onClick:r=>se(n)},{default:e.withCtx(()=>t[15]||(t[15]=[e.createTextVNode("删除 ")])),_:2},1032,["disabled","onClick"])]),_:1})]),_:1},8,["data"])]),_:1}),e.createVNode(a,{label:"商品选择",prop:"productType"},{default:e.withCtx(()=>[e.createVNode(xe,{modelValue:e.unref(d).productType,"onUpdate:modelValue":t[2]||(t[2]=n=>e.unref(d).productType=n),disabled:e.unref(i),onChange:ue},{default:e.withCtx(()=>[e.createVNode(w,{value:"ALL_PRODUCT"},{default:e.withCtx(()=>t[16]||(t[16]=[e.createTextVNode("全部商品参与")])),_:1}),e.createVNode(w,{value:"SPECIFIED_PRODUCT_PARTICIPATE"},{default:e.withCtx(()=>t[17]||(t[17]=[e.createTextVNode("指定商品参与")])),_:1}),e.createVNode(w,{value:"SPECIFIED_PRODUCT_NOT_PARTICIPATE"},{default:e.withCtx(()=>t[18]||(t[18]=[e.createTextVNode("指定商品不参与")])),_:1})]),_:1},8,["modelValue","disabled"]),e.unref(d).productType!=="ALL_PRODUCT"?(e.openBlock(),e.createElementBlock("div",{key:0,class:e.normalizeClass([e.unref(s).length&&"goodsData","goods-list"])},[e.createVNode(S,{data:e.unref(s),"header-cell-style":{fontSize:"14px",color:"#606266",background:"#f2f2f2",height:"54px",fontWeight:"normal"},height:"500px",style:{width:"100%"}},{default:e.withCtx(()=>[e.createVNode(C,{label:`商品信息${e.unref(s).length?`(已选择${e.unref(s).length}款商品)`:""}`},{default:e.withCtx(({row:n})=>[e.createElementVNode("div",Y,[e.createVNode(ge,{"preview-src-list":[n.pic],"preview-teleported":!0,src:n.pic,fit:"",style:{width:"60px",height:"60px"}},null,8,["preview-src-list","src"]),e.createElementVNode("div",H,[e.createElementVNode("div",X,e.toDisplayString(n.productName),1)])])]),_:1},8,["label"]),e.createVNode(C,{width:"110",fixed:"right"},{header:e.withCtx(()=>[e.createVNode(I,{disabled:e.unref(i),plain:"",round:"",size:"small",type:"primary",onClick:t[3]||(t[3]=n=>V.value=!0)},{default:e.withCtx(()=>t[19]||(t[19]=[e.createTextVNode(" 添加商品 ")])),_:1},8,["disabled"])]),default:e.withCtx(({row:n})=>[e.createVNode(h,{disabled:e.unref(i),underline:!1,type:"primary",onClick:r=>ae(n.productId)},{default:e.withCtx(()=>t[20]||(t[20]=[e.createTextVNode(" 删除 ")])),_:2},1032,["disabled","onClick"])]),_:1})]),_:1},8,["data"])],2)):e.createCommentVNode("",!0)]),_:1})]),_:1},8,["model","rules"]),e.createVNode(F,{modelValue:e.unref(V),"onUpdate:modelValue":t[4]||(t[4]=n=>e.isRef(V)?V.value=n:null),pointGoodsList:e.unref(s),searchConsignmentProduct:!0,onOnConfirm:ie},null,8,["modelValue","pointGoodsList"])]),e.createElementVNode("div",W,[e.createVNode(I,{plain:"",round:"",onClick:t[5]||(t[5]=n=>e.unref(b).back())},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(e.unref(i)?"返回":"取消"),1)]),_:1}),e.unref(i)?e.createCommentVNode("",!0):(e.openBlock(),e.createBlock(M,{key:0,round:"",type:"primary",onClick:oe},{default:e.withCtx(()=>t[21]||(t[21]=[e.createTextVNode("确定")])),_:1}))])],64)}}}),he="";return((f,b)=>{const g=f.__vccOpts||f;for(const[x,_]of b)g[x]=_;return g})(J,[["__scopeId","data-v-f903f8bf"]])});
