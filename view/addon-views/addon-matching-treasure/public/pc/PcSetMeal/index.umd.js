(function(e,z){typeof exports=="object"&&typeof module<"u"?module.exports=z(require("vue"),require("vue-router"),require("element-plus"),require("@/apis/http"),require("@/composables/useConvert"),require("decimal.js"),require("lodash-es"),require("@/libs/storage"),require("@/utils/date"),require("@/components/q-icon/q-icon.vue")):typeof define=="function"&&define.amd?define(["vue","vue-router","element-plus","@/apis/http","@/composables/useConvert","decimal.js","lodash-es","@/libs/storage","@/utils/date","@/components/q-icon/q-icon.vue"],z):(e=typeof globalThis<"u"?globalThis:e||self,e.PcSetMeal=z(e.PcSetMealContext.Vue,e.PcSetMealContext.VueRouter,e.PcSetMealContext.ElementPlus,e.PcSetMealContext.Request,e.PcSetMealContext.UseConvert,e.PcSetMealContext.Decimal,e.PcSetMealContext.Lodash,e.PcSetMealContext.storage,e.PcSetMealContext.DateUtil,e.PcSetMealContext.QIcon))})(this,function(e,z,B,Q,pe,fe,me,be,ve,Ne){"use strict";var Qt=Object.defineProperty;var Yt=(e,z,B)=>z in e?Qt(e,z,{enumerable:!0,configurable:!0,writable:!0,value:B}):e[z]=B;var ae=(e,z,B)=>(Yt(e,typeof z!="symbol"?z+"":z,B),B);var he=document.createElement("style");he.textContent=`@charset "UTF-8";.active[data-v-98d1bbe4]{border:2px solid red}.disable[data-v-98d1bbe4]{color:#ccc;border:none;background:#f6f6f6}.title[data-v-98d1bbe4]{padding:0 8px;white-space:nowrap;display:inline-block;margin-top:15px}.confirmBtn[data-v-98d1bbe4]{padding-top:25px;width:100%;text-align:right}.el-button[data-v-98d1bbe4]{background-color:#555cfd;color:#fff}.box[data-v-98d1bbe4]{padding:20px}.countdown-view[data-v-e1e9600a]{display:flex;align-items:center}.countdown-view--item[data-v-e1e9600a]{border-radius:50%;text-align:center}.countdown-view--item-pendant[data-v-e1e9600a]{margin:0 2px}.countdown-view--item-day[data-v-e1e9600a]{margin-right:5rpx}img[data-v-c91d9a8a]{width:100%;height:100%}.colorRed[data-v-c91d9a8a]{color:red}.textFw[data-v-c91d9a8a]{font-weight:700}.boxBorder[data-v-c91d9a8a]{border:2px solid #ff0000!important}.loader-container[data-v-c91d9a8a]{position:fixed;top:0;left:0;width:100%;height:100%;background-color:#ffffffb3;z-index:1000;display:flex;justify-content:center;align-items:center}.loader[data-v-c91d9a8a]{border:5px solid #c7c7c7;border-radius:50%;border-top:5px solid #ff0000;width:50px;height:50px;animation:spin-c91d9a8a 1s linear infinite}@keyframes spin-c91d9a8a{0%{transform:rotate(0)}to{transform:rotate(360deg)}}.con[data-v-c91d9a8a]{width:1190px;margin:0 auto}.content[data-v-c91d9a8a]{position:relative;display:flex;padding:12px 6px}.content__box[data-v-c91d9a8a]{position:relative;width:150px;height:220px;border-radius:4px;border:2px solid #c7c7c7}.content__box--img[data-v-c91d9a8a]{text-align:center;padding:12px 0 8px}.content__box--img img[data-v-c91d9a8a]{width:100px;height:100px}.content__box--tilText[data-v-c91d9a8a]{padding:0 10px;margin-bottom:3px;text-align:left;word-break:break-all;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}.content__box--price[data-v-c91d9a8a]{padding:0 10px;font-size:16px;text-align:left}.content__box--select[data-v-c91d9a8a]{position:relative;text-align:left;margin:3px 10px;cursor:pointer;border:1px solid #c7c7c7;border-radius:3px}.content__box--sel[data-v-c91d9a8a]{line-height:24px;margin:1px 10px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:flex;justify-content:space-between;align-items:center}.content__box--sel p[data-v-c91d9a8a]{max-width:90px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.content__box--specification[data-v-c91d9a8a]{position:absolute;top:35px;left:0;max-width:550px;background-color:#fff;z-index:99;box-shadow:2px 2px 5px 1px #999}.content__box--til[data-v-c91d9a8a]{margin:10px}.content__box--body[data-v-c91d9a8a]{padding:2px 6px;margin:5px;display:inline-block;border:2px solid transparent;background-color:#e6e6e6;cursor:pointer}.content__plusSign[data-v-c91d9a8a]{text-align:center;line-height:40px;margin:90px 0 0 31px}.content__rightBox[data-v-c91d9a8a]{position:absolute;right:0;display:flex;justify-content:center;flex-direction:column;align-items:end;height:218px;font-size:14px;margin:0 25px 0 0}.content__rightBox--price[data-v-c91d9a8a]{margin:10px 0}.content__rightBox--btn[data-v-c91d9a8a]{width:104px;height:32px;line-height:32px;color:#fff;background-color:#e31436;margin:10px 0;cursor:pointer}.content__rightBox--over[data-v-c91d9a8a]{text-align:right;font-size:12px;color:#999;display:flex;align-items:center;margin:0 auto}.confirmBtn[data-v-c91d9a8a]{width:100%;text-align:right;padding:10px 30px 30px 0}.el-button[data-v-c91d9a8a]{background-color:#555cfd;color:#fff}.else[data-v-c91d9a8a]{order:2;margin:1px 10px}.one[data-v-c91d9a8a]{order:-1}
`,document.head.appendChild(he);const ge="addon-matching-treasure/consumer/",Ve=(N,b)=>Q.get({url:ge+`setMealBasicInfo/${N}/${b}`}),Me=(N,b)=>Q.get({url:ge+`setMealDetail/${N}/${b}`}),Ee=(N,b)=>Q.get({url:`gruul-mall-storage/storage/shop/${N}/product/${b}`}),we=(N,b)=>Q.get({url:`gruul-mall-goods/api/product/get/${N}`,headers:{"Shop-Id":b}}),Ce=N=>Q.get({url:`gruul-mall-shop/shop/info/base/${N}`}),Ie=N=>Q.post({url:"gruul-mall-goods/api/product/productDelivery",data:N}),Pe=N=>Q.post({url:"gruul-mall-order/order/budget",data:N}),Be=()=>Q.get({url:"gruul-mall-user/user/address/default"});class Ae{constructor(b){ae(this,"vertex",[]);ae(this,"quantity",0);ae(this,"vertexRange",[]);this.vertex=b,this.quantity=b.length,this.init()}init(){this.vertexRange=Array.from({length:this.quantity*this.quantity})}setVertexRange(b,h){const V=this.vertex.indexOf(b);h.forEach(i=>{const x=this.vertex.indexOf(i);this.vertexRange[V*this.quantity+x]=1})}getVertexColumn(b){const h=this.vertex.indexOf(b),V=[];return this.vertex.forEach((i,x)=>{V.push(this.vertexRange[h+this.quantity*x])}),V}getColumnTotal(b){const h=b.map(i=>this.getVertexColumn(i)),V=[];return this.vertex.forEach((i,x)=>{const J=h.map(k=>k[x]).reduce((k,K)=>(k+=K||0,k),0);V.push(J)}),V}getIntersection(b){return this.getColumnTotal(b).map((V,i)=>V>=b.length&&this.vertex[i]).filter(Boolean)}getUnion(b){return this.getColumnTotal(b).map((V,i)=>V&&this.vertex[i]).filter(Boolean)}}class xe extends Ae{constructor(h,V){super(h.reduce((i,x)=>[...i,...x.list],[]));ae(this,"commoditySpecs",[]);ae(this,"normGroup",[]);this.commoditySpecs=h,this.normGroup=V,this.initMatrix(),this.initSimilarVertex()}initMatrix(){this.normGroup.forEach(h=>{this.applyCommodity(h.specs)})}initSimilarVertex(){const h=this.getUnion(this.vertex);this.commoditySpecs.forEach(V=>{const i=[];V.list.forEach(x=>{h.indexOf(x)>-1&&i.push(x)}),this.applyCommodity(i)})}querySpecsOptions(h){return h!=null&&h.some(Boolean)?h=this.getIntersection(h.filter(Boolean)):h=this.getUnion(this.vertex),h}applyCommodity(h){h.forEach(V=>{this.setVertexRange(V,h)})}}const De={class:"box"},Te={key:0},Oe={flex:"","c-mt-13":""},$e={"e-tj":"","c-mr-23":"","c-mt-11":"",class:"title"},Re={flex:"","items-center":"","flex-wrap":"","c-w-630":""},Ge=["onClick"],qe={"c-lh-42":"",style:{"min-width":"30px","text-align":"center"}},je={flex:"","c-mt-13":""},Fe={"e-tj":"","c-mr-23":"","c-mt-11":"",class:"title"},Ue={flex:"","items-center":"","flex-wrap":"","c-w-630":""},ze=["onClick"],Je={"e-c-3":"","c-lh-42":"",style:{"min-width":"30px","text-align":"center"}},Le=e.defineComponent({__name:"good-spec",props:{skuGroup:{type:Object,default(){return{}}},currentChoose:{type:Array,default(){return[]}},imgBoolean:{type:Boolean,default:!0},disableSpec:{type:Array,default(){return[]}},params:{type:Object,default(){return{}}}},emits:["chooseSpec","init-complete"],setup(N,{expose:b,emit:h}){var se;const{divTenThousand:V}=pe(),i=N,x=e.shallowReactive({commoditySpecs:[],optionSpec:[],chooseSpec:[],normClass:new xe([],[])});let J;const k=e.ref({}),K=e.ref((se=i.params.productAttributes)==null?void 0:se.map(l=>({...l,featureValues:k.value[l.id]||[]}))),P=h,te=()=>{var n;const l=i.params.productAttributes,f=((n=i.skuGroup.specGroups)==null?void 0:n.length)===0?K.value:x.chooseSpec.length;l&&f?(l.forEach(_=>{k.value[_.id]=[]}),K.value=l.map(_=>({..._,featureValues:k.value[_.id]})),J=j(),P("chooseSpec",J,!1),e.nextTick(()=>{P("init-complete",{specsObj:k,handleCheckbox:A,productAttributes:K.value})})):setTimeout(()=>{te()},500)};e.onMounted(()=>{te()}),e.watch(i.skuGroup,l=>{if(l){const f=JSON.parse(JSON.stringify(l));let n=[],_=[];i.skuGroup.specGroups&&i.skuGroup.specGroups.length>0&&(n=U(f.specGroups),_=L(f.skus,i.disableSpec)),x.commoditySpecs=n;const S=new xe(n,_);x.commoditySpecs=n,x.normClass=S,!i.currentChoose.length&&f.skus.length>0?x.chooseSpec=f.skus[0].specs:i.currentChoose.length&&f.skus.length>0?x.chooseSpec=JSON.parse(JSON.stringify(i.currentChoose)):x.chooseSpec=Array.from({length:n.length}),x.optionSpec=S.querySpecsOptions(x.chooseSpec)}},{immediate:!0});const Z=me.debounce((l,f,n)=>{const{commoditySpecs:_,chooseSpec:S,normClass:p,optionSpec:O}=e.toRefs(x);S.value[n]===f||!l||(S.value[n]=S.value[n]===f?"":f,S.value=S.value.slice(),O.value=p.value.querySpecsOptions(S.value.slice()),S.value.filter(Boolean).length===_.value.length&&P("chooseSpec",j()))},300,{leading:!0,trailing:!1});function j(){var p;const l=e.toRaw(i.skuGroup.skus),f=((p=i.skuGroup.specGroups)==null?void 0:p.length)===0?l:l.filter(O=>T(O.specs,x.chooseSpec)),n=me.cloneDeep(f);let _=0,S;for(S in k.value)_+=k.value[S].reduce((O,W)=>O+Number(W.secondValue),0);return n[0]&&(n[0].salePrice=String((+n[0].salePrice||0)+_),n[0].attributePirce=String(_)),n}function T(l,f){if(l.length!==f.length)return!1;for(let n=0;n<l.length;n++)if(l[n]!==f[n])return!1;return!0}function U(l){return l?l.map(f=>({title:f.name,list:f.children.map(n=>n.name)})):[]}function L(l,f){const n=[];return l.forEach(_=>{var p;f.includes((p=_.specs)==null?void 0:p.join(","))||n.push({id:_.id,specs:_.specs})}),n}const A=(l,f,n,_)=>{l?_?k.value[n]=[...k.value[n],f]:k.value[n]=[f]:k.value[n]=k.value[n].filter(p=>p.featureValueId!==f.featureValueId);let S=new fe(0);for(const p in k.value)S=k.value[p].reduce((O,W)=>O.add(V(W.secondValue).toNumber()),S);K.value=i.params.productAttributes?i.params.productAttributes.map(p=>({...p,featureValues:k.value[p.id]})):[],P("chooseSpec",j(),!1)};return b({productAttributes:K,params:i.params,commoditySpecs:x.commoditySpecs}),(l,f)=>(e.openBlock(),e.createElementBlock("div",De,[N.skuGroup.specGroups&&N.skuGroup.specGroups.length<=0?(e.openBlock(),e.createElementBlock("div",Te,f[0]||(f[0]=[e.createElementVNode("div",{class:"norm"},[e.createElementVNode("div",{flex:"","c-mt-13":""},[e.createElementVNode("div",{"e-tj":"","c-mr-23":"","c-mt-11":"",class:"title"},"规格"),e.createElementVNode("div",{flex:"","items-center":"","flex-wrap":"","c-w-630":""},[e.createElementVNode("div",{"c-lh-42":"",style:{"min-width":"30px","text-align":"center"}},[e.createElementVNode("div",{"c-lh-34":"","b-2":"","c-bc-e0e0e0":"","c-mr-7":"","c-mt-5":"","e-c-3":"","c-pl-15":"","c-pr-15":"",class:"active"},"默认")])])])],-1)]))):e.createCommentVNode("",!0),(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(e.unref(x).commoditySpecs,(n,_)=>(e.openBlock(),e.createElementBlock("div",{key:_,class:"norm"},[e.createElementVNode("div",Oe,[e.createElementVNode("div",$e,e.toDisplayString(n.title),1),e.createElementVNode("div",Re,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(n.list,(S,p)=>(e.openBlock(),e.createElementBlock("div",{key:p,"c-lh-34":"","b-2":"","c-bc-e0e0e0":"","c-mr-7":"","c-mt-5":"","e-c-3":"","c-pl-15":"","c-pr-15":"",class:e.normalizeClass({active:e.unref(x).chooseSpec.indexOf(S)!==-1,disable:e.unref(x).optionSpec.indexOf(S)===-1}),onClick:O=>e.unref(Z)(e.unref(x).optionSpec.indexOf(S)>-1,S,_)},[e.createElementVNode("div",qe,e.toDisplayString(S),1)],10,Ge))),128))])])]))),128)),(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(N.params.productAttributes,n=>(e.openBlock(),e.createElementBlock("div",{key:n.id,class:"norm"},[e.createElementVNode("div",je,[e.createElementVNode("div",Fe,e.toDisplayString(n.featureName)+"("+e.toDisplayString(n.isRequired?"必选":"非必选")+")("+e.toDisplayString(n.isMultiSelect?"多选":"单选")+") ",1),e.createElementVNode("div",Ue,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(n.featureValues,_=>{var S;return e.openBlock(),e.createElementBlock("div",{key:_.featureValueId,class:e.normalizeClass({active:((S=k.value[n.id])==null?void 0:S.find(p=>p.featureValueId===_.featureValueId))!==void 0}),"c-lh-34":"","b-2":"","c-bc-e0e0e0":"","c-mr-7":"","c-mt-5":"","e-c-3":"","c-pl-15":"","c-pr-15":"",onClick:p=>{var O;return A(((O=k.value[n.id])==null?void 0:O.find(W=>W.featureValueId===_.featureValueId))===void 0,_,n.id,n.isMultiSelect)}},[e.createElementVNode("div",Je,e.toDisplayString(`${_.firstValue}${_.secondValue&&new(e.unref(fe))(_.secondValue).lte(0)?"":"+"}${e.unref(V)(_.secondValue)}`)+"元 ",1)],10,ze)}),128))])])]))),128))]))}}),Zt="",ne=(N,b)=>{const h=N.__vccOpts||N;for(const[V,i]of b)h[V]=i;return h},Xe=ne(Le,[["__scopeId","data-v-98d1bbe4"]]),Ke={class:"countdown-view"},He={class:e.normalizeClass(["countdown-view--item","countdown-view--item-day"])},We={class:e.normalizeClass(["countdown-view--item"])},Qe={class:e.normalizeClass(["countdown-view--item"])},Ye={class:e.normalizeClass(["countdown-view--item"])},Ze=60*60*1e3-1e3,et=e.defineComponent({__name:"countdown",props:{startTime:{type:String,default:""},isStart:{type:Boolean,default:!1}},emits:["end"],setup(N,{expose:b,emit:h}){function V(j){let T,U=parseInt((j%864e5/36e5).toString()),L=parseInt((j%(1e3*60*60)/(1e3*60)).toString()),A=parseInt((j%(1e3*60)/1e3).toString());return T=(U<10?"0"+U:U)+":"+(L<10?"0"+L:L)+":"+(A<10?"0"+A:A),T}const i=N,x=h;let J=null;const k=e.ref(["00","00","00"]),K=new ve;e.watch(()=>i.startTime,()=>{P()}),P();function P(){J&&clearInterval(J),k.value=["00","00","00"],te(i.isStart)}e.onBeforeUnmount(()=>{J&&clearInterval(J)});function te(j){if(!i.startTime)return;const T=new Date().getTime(),U=K.getTime(new Date(i.startTime));let L=j?U-T:U+Ze-T;L<0||(J=setInterval(()=>{if(L<1e3){x("end"),J&&clearInterval(J);return}L=L-1e3,k.value=V(L).split(":")},1e3))}function Z(j){const T=new Date,U=(new Date(j.replace(/-/g,"/")).getTime()-T.getTime())/(1e3*3600*24);return Math.floor(U)<0?"":Math.floor(U)<10?`0${Math.floor(U)}`:Math.floor(U)}return b({loadCountdown:P}),(j,T)=>(e.openBlock(),e.createElementBlock("view",Ke,[e.renderSlot(j.$slots,"default",{day:Z(N.startTime),timeArr:k.value},()=>[+Z(N.startTime)>0?(e.openBlock(),e.createElementBlock(e.Fragment,{key:0},[e.createElementVNode("text",He,e.toDisplayString(Z(N.startTime)),1),T[0]||(T[0]=e.createElementVNode("text",{class:"countdown-view--item-pendant"},"天",-1))],64)):e.createCommentVNode("",!0),e.createElementVNode("text",We,e.toDisplayString(k.value[0]),1),T[1]||(T[1]=e.createElementVNode("text",{class:"countdown-view--item-pendant"},":",-1)),e.createElementVNode("text",Qe,e.toDisplayString(k.value[1]),1),T[2]||(T[2]=e.createElementVNode("text",{class:"countdown-view--item-pendant"},":",-1)),e.createElementVNode("text",Ye,e.toDisplayString(k.value[2]),1)],!0)]))}}),eo="",tt=ne(et,[["__scopeId","data-v-e1e9600a"]]),ot={key:0,class:"con"},at={key:0,class:"loader-container"},st={class:"content__products",style:{display:"flex","max-width":"1020px","flex-wrap":"wrap"}},rt={class:"content__plusSign content__plusSign--left",style:{order:"1"}},nt=["onClick"],ct=["src"],lt=["onClick"],it=["onClick"],dt={class:"content__box--select"},ut=["onClick"],pt={key:0,class:"content__box--specification"},ft={class:"confirmBtn"},mt={class:"content__rightBox"},ht={class:"content__rightBox--info"},gt={class:"content__selected-count"},xt={class:"colorRed"},yt={class:"content__rightBox--price"},_t={class:"colorRed"},kt={class:"content__total-price"},St={class:"colorRed textFw",style:{"font-size":"18px"}},bt=["onClick"],vt={class:"content__rightBox--over"},Nt={class:"content__countdown"},Vt=e.defineComponent({__name:"PcSetMeal",props:{properties:{type:Object,default:()=>({})}},setup(N){const b=z.useRouter(),h=z.useRoute(),{divTenThousand:V}=pe(),i=e.ref(!1),x=e.computed(()=>h.query.shopId),J=e.computed(()=>h.query.productId),k=e.ref([]),K=e.ref([]),P=e.ref([]),te=e.ref(""),Z=e.ref("EXPRESS"),j=e.ref(),T=e.ref(""),U=e.ref(""),L=e.ref(0),A=e.ref(),se=e.ref({}),l=e.ref({}),f=e.reactive({}),n=e.ref(1),_=e.ref([]),S=e.ref(!1),p=e.ref(""),O=e.ref(-1),W=e.ref(0),ce=e.ref(0),oe=e.ref(),ye=e.ref(),re=e.ref(),C=e.reactive([_e()]);function _e(){return Array(5).fill(null).map(()=>({checkBox:!1,skuId:"",price:0,original:0,salePrices:0,name:"",type:"",specs:""}))}const Mt=async()=>{var o;try{i.value=!0;const{code:t,data:a}=await Ve(x.value,J.value);if(t===200&&a){if(T.value=(o=a==null?void 0:a[0])==null?void 0:o.setMealId,k.value=a,K.value=a.map(s=>s.setMealId).filter(Boolean),k.value.length>C.length){const s=k.value.length-C.length;for(let d=0;d<s;d++)C.push(_e())}return!0}return!1}catch(t){return console.error("获取套餐基本信息失败:",t),B.ElMessage.error("获取套餐基本信息失败"),!1}finally{i.value=!1}},Et=async o=>{try{const{data:t,code:a}=await Ee(x.value,o);return a===200?t:[]}catch(t){return console.error("获取商品SKU失败:",t),[]}},wt=async()=>{try{if(i.value=!0,!await Mt())return;for(const t of K.value){const{code:a,data:s}=await Me(x.value,t);a!==200||!s||(Z.value=s.distributionMode,P.value.push(s),te.value=s.setMealType,j.value=s.setMealProductDetails,Ct(s.setMealProductDetails),It(P.value.length-1))}}catch(o){console.error("获取套餐详细信息失败:",o),B.ElMessage.error("获取套餐详细信息失败")}finally{i.value=!1}},Ct=o=>{const t={};o.forEach(a=>{var s;if(a.setMealProductSkuDetails.length===1){const d=a.setMealProductSkuDetails[0],c={...d.storageSku,salePrice:d.matchingPrice,stock:d.matchingStock,id:d.skuId,specs:d.skuName,stockType:d.stockType,saveAtLeast:d.saveAtLeast,productName:a.productName,productAttributes:a.productAttributes};(a.productAttributes==="MAIN_PRODUCT"||((s=P.value[0])==null?void 0:s.setMealType)==="FIXED_COMBINATION")&&Se(a.productId,c),t[a.productId]=c}}),ke(t)},It=o=>{if(o>=P.value.length)return;const t=P.value[o],a=C[o];for(let s=0;s<t.setMealProductDetails.length;s++){const d=t.setMealProductDetails[s];if(d.productAttributes==="MAIN_PRODUCT"&&(a[s].checkBox=!0,a[s].type="MAIN_PRODUCT"),d.setMealProductSkuDetails.length>0){const c=d.setMealProductSkuDetails[0];a[s].skuId=c.skuId,a[s].name=d.productName,a[s].type=d.productAttributes}t.setMealType==="FIXED_COMBINATION"&&(a[s].checkBox=!0)}};e.onMounted(()=>{wt()});const Pt=o=>Array.isArray(o)?(o.flatMap(a=>a.featureValues)||[]).map(a=>{const s=V(a.secondValue);return`${a.firstValue}${s.lte(0)?"":"+"}${s}元`}):[],le=async(o,t,a,s,d)=>{if(d==="MAIN_PRODUCT"||a==="FIXED_COMBINATION")return;const c=C[s][t];c.checkBox?(c.checkBox=!1,n.value-=1):c.price===0?B.ElMessage.error("请先选规格再选商品"):(c.checkBox=!0,n.value+=1,c.name=o.productName)},Bt=async(o,t,a,s,d)=>{var G,R,X;const{productId:c,productName:r,productAttributes:m,setMealProductSkuDetails:g}=t;p.value=c,W.value=a,O.value=o;const I=C[a][o],$=I.specs||"",E=[];if(g.forEach(w=>{if(w.matchingStock===0)return;let u=[];const D=w.skuName;D&&(typeof D=="string"?u=D.split(","):Array.isArray(D)&&(u=D)),E.push({...w.storageSku,salePrice:w.matchingPrice,stock:w.matchingStock,id:w.skuId,specs:u,stockType:w.stockType,productName:r,productAttributes:m})}),E.length===0){B.ElMessage.warning("该商品暂无库存");return}try{const w=await we(c,x.value);let u=((R=(G=w.data)==null?void 0:G.extra)==null?void 0:R.productAttributes)||[];if(u.length>0){console.log("原始属性数据:",JSON.stringify(u));const v=f[c]||[];console.log("已保存的属性数据:",JSON.stringify(v)),u=JSON.parse(JSON.stringify(u)),u=u.map(H=>{const Y=v.find(ee=>ee.id===H.id);return Y&&Y.featureValues&&Y.featureValues.length>0?H.featureValues=H.featureValues.map(ee=>(Y.featureValues.some(de=>de.featureValueId===ee.featureValueId)&&(ee._selected=!0),ee)):H.isRequired&&H.featureValues&&H.featureValues.length>0&&(H.featureValues[0]._selected=!0),H});const F={...w.data.extra,productAttributes:u};oe.value=F,console.log("更新后的属性数据:",JSON.stringify(u))}else oe.value=w.data.extra;const D=await Et(c),{specGroups:q}=D;ye.value={specGroups:q,skus:E.map((v,F)=>({...v,salePrices:w.data.salePrices[F]}))};let M=[];if((X=l.value[c])!=null&&X.specs){const v=l.value[c].specs;M=Array.isArray(v)?v:typeof v=="string"?v.split(","):[]}else $&&$!=="请选择规格"&&(M=$.split(","));if(M.length===0&&$){const v=E.find(F=>Array.isArray(F.specs)&&F.specs.join(",")===$);v&&(M=v.specs)}M.length===0&&E.length>0&&(M=E[0].specs||[]);let y=E[0];if(M.length>0){const v=E.find(F=>Array.isArray(F.specs)&&F.specs.length===M.length&&F.specs.every((H,Y)=>H===M[Y]));v&&(y=v)}A.value={...y,salePrices:w.data.salePrices[E.indexOf(y)],specs:M},I.name=r,M.length>0&&(I.specs=M.join(",")),O.value!==o?S.value=!0:S.value=!S.value,ce.value=Date.now(),console.log("Opening spec selector for",r,"with selected specs:",M)}catch(w){console.error("获取商品规格信息失败:",w),B.ElMessage.error("获取商品规格信息失败")}},At=o=>{var t;o.length&&(A.value=o[0],_.value[O.value]=o[0],W.value>=0&&O.value>=0&&(C[W.value][O.value].skuId=((t=o[0])==null?void 0:t.id)||""))},Dt=o=>{S.value=o},Tt=o=>{if(!o||!oe.value||!oe.value.productAttributes)return;console.log("GoodSpec初始化完成");const t=oe.value.productAttributes;if(!t.length)return;let a=!1;t.forEach(s=>{if(!s.featureValues)return;const d=s.featureValues.filter(c=>c._selected);d.length>0&&(a=!0,d.forEach(c=>{const r={...c};o.handleCheckbox&&s.id&&(o.specsObj.value[s.id]||(o.specsObj.value[s.id]=[]),o.specsObj.value[s.id].some(g=>g.featureValueId===r.featureValueId)||o.handleCheckbox(!0,r,s.id,s.isMultiSelect))}))}),a&&console.log("已预设属性选中状态")},Ot=()=>{var G,R,X,w;if(!re.value||!re.value[0])return B.ElMessage.error("规格选择器未初始化");const o=re.value[0].productAttributes||[];if(o.length){let u;if(!o.some(q=>{var M;return!q.isRequired||q.isRequired&&((M=q.featureValues)!=null&&M.length)?!0:(u=q,!1)}))return B.ElMessage.error(`${u.featureName}为必选项`)}const t={[p.value]:A.value},a=A.value?+A.value.salePrice:0,s=A.value?+zt(A.value.id):0,d=a||s,c=A.value?Number(A.value.attributePirce):0,r=A.value?Number(A.value.salePrices):0,g=(o.flatMap(u=>u.featureValues)||[]).map(u=>u.firstValue+u.secondValue/1e4+"元");o.length>0&&(f[p.value]||(f[p.value]=[]),o.forEach(u=>{const D=f[p.value].findIndex(q=>q.id===u.id);D>=0?f[p.value][D].featureValues=u.featureValues?JSON.parse(JSON.stringify(u.featureValues)):[]:f[p.value].push({id:u.id,featureName:u.featureName,isRequired:u.isRequired,isMultiSelect:u.isMultiSelect,featureValues:u.featureValues?JSON.parse(JSON.stringify(u.featureValues)):[]})}));let I="";(R=(G=t[p.value])==null?void 0:G.specs)!=null&&R.length?I=[...t[p.value].specs,...g].join(","):g.length?I=[...g].join(","):U.value===p.value&&(g.length===0||!t)&&((X=j.value)==null||X.forEach(u=>{u.productId===p.value&&(u.flag=!0)}));const $=C[W.value][O.value];Object.assign($,{price:d,original:c,salePrices:r,specs:I===""?"默认":I,skuId:((w=A.value)==null?void 0:w.id)||""}),e.nextTick(()=>{if(ke(t),t[p.value]){const u=Array.isArray(t[p.value].specs)?t[p.value].specs:typeof t[p.value].specs=="string"?t[p.value].specs.split(","):[],D=f[p.value]||[],q={...t[p.value],specs:u,productFeatures:D.length>0?JSON.parse(JSON.stringify(D)):[],attributeSelections:D.reduce((M,y)=>(y.featureValues.forEach(v=>{v&&v.featureValueId&&(M[y.id]||(M[y.id]=[]),M[y.id].push(v.featureValueId))}),M),{})};Se(p.value,q)}$t(p.value),Dt(!1),ce.value=Date.now(),console.log("Saved attributes:",f[p.value]),console.log("Saved SKU:",l.value[p.value])})},$t=o=>{if(!f[o]||!l.value[o])return;let t=0;f[o].forEach(a=>{var s;(s=a.featureValues)==null||s.forEach(d=>{d&&typeof d.secondValue<"u"&&(t+=Number(d.secondValue||0))})}),l.value[o]&&(l.value[o].attributePirce=String(t))},Rt=o=>{let t=0;return o.forEach(a=>{a.checkBox&&(t+=Math.max(0,a.price))}),V(t)},Gt=(o,t)=>{if(A.value&&Number(A.value.stock)===0)return B.ElMessage.error("该规格商品库存不足"),!1;const a=P.value[t],s=C[t];if(console.log("开始验证购买条件:",{setMealType:o.setMealType,checkBoxList:s,productDetails:a.setMealProductDetails.map(r=>({name:r.productName,type:r.productAttributes,skuCount:r.setMealProductSkuDetails.length}))}),o.setMealType==="FIXED_COMBINATION"){const r=s.filter(m=>m.price!==0).length;if(o.setMealProductDetails.length!==r){const m=[];for(let g=0;g<o.setMealProductDetails.length;g++)(!s[g]||s[g].price===0)&&m.push(o.setMealProductDetails[g].productName);return B.ElMessage.error(`固定套餐模式下需要选择所有商品的规格，还缺少: ${m.join(", ")}`),!1}return!0}const d=a.setMealProductDetails.filter(r=>r.productAttributes==="MAIN_PRODUCT");for(const r of d)if(!s.find(g=>g.name===r.productName&&g.price>0&&g.checkBox===!0))return B.ElMessage.error(`请选择主商品"${r.productName}"的规格`),!1;const c=a.setMealProductDetails.filter(r=>r.productAttributes!=="MAIN_PRODUCT");return console.log("搭配商品验证:",{additionalProductsCount:c.length,selectedCheckBoxes:s.filter(r=>r.checkBox===!0&&r.type!=="MAIN_PRODUCT").map(r=>r.name),itemsWithPrice:s.filter(r=>r.price>0&&r.type!=="MAIN_PRODUCT").map(r=>r.name+" (勾选状态:"+r.checkBox+")")}),c.length>0&&s.filter(m=>m.type!=="MAIN_PRODUCT"&&m.checkBox===!0&&m.price>0).length===0?(B.ElMessage.error("请至少选择一种搭配商品"),!1):!0},qt=(o,t)=>{Gt(o,t)&&jt(C[t],o)},jt=async(o,t)=>{var a,s,d,c;try{i.value=!0;const{code:r,data:m,msg:g}=await Ce(x.value);if(r!==200||!m)return B.ElMessage.error(g||"获取店铺基本信息失败");let I={};const $=[];t!=null&&t.setMealProductDetails&&t.setMealProductDetails.forEach(y=>{$.push(y.productId)});const E=[];if(o&&Array.isArray(o)&&o.forEach(y=>{y.checkBox&&y.skuId&&E.push(y.skuId)}),$.length>0)for(const y in l.value)$.includes(y)&&(E.length===0||E.includes(l.value[y].id))&&(I[y]=l.value[y]);else if(E.length>0)for(const y in l.value)E.includes(l.value[y].id)&&(I[y]=l.value[y]);else for(const y of C)for(const v of y)if(v.checkBox&&v.skuId)for(const F in l.value)l.value[F].id===v.skuId&&(I[F]=l.value[F]);if(Object.keys(I).length===0)return B.ElMessage.error("请选择至少一个商品");const G=await Ut(I);if(!G)return;const{deliveryData:R}=G,X=[],w=[];for(const y in I){const v=R.find(ue=>ue.productId===y),{image:F,price:H,salePrice:Y,productName:ee,id:ie,productAttributes:de,skuStock:Xt,specs:Kt}=I[y],Ht={skuId:ie,image:F||((a=P.value[0].setMealProductDetails.find(ue=>ue.productId===y))==null?void 0:a.productPic),price:H,id:y,salePrice:Y,productId:y,distributionMode:P.value[0].distributionMode,productName:ee,num:1,freightTemplateId:v==null?void 0:v.freightTemplateId,weight:(v==null?void 0:v.weight)??"0",productFeaturesValue:f[y]||null,specs:[...Kt,...Pt(f[y]||[])]},Wt={activityId:T.value,productAttributes:de,shopId:x.value,skuId:ie,skuStock:Xt,productId:y};X.push(Ht),w.push(Wt)}const u=[{...m,shopLogo:m.logo,shopName:m.name,groupBuying:!0,shopId:m.id,products:X,orderType:"PACKAGE",distributionMode:P.value[0].distributionMode,activityParam:{type:"PACKAGE",activityId:T.value,extra:{setMealProducts:w},stackable:(s=P.value[0])==null?void 0:s.stackable}}];let D={name:"",mobile:"",area:[],address:"",location:{type:"Point",coordinates:[121.489551,29.936806]},isDefault:!1};const q=await Be();q.code===200&&((c=(d=q.data)==null?void 0:d.area)!=null&&c.length)?D=q.data:B.ElMessage.warning("请添加收货地址");const M=await Ft(u[0],D);if(M.code===20025)return B.ElMessage.error(M.msg);new be().setItem("commodityInfo",u,60*60*2),b.push({path:"/settlement",query:{source:"PRODUCT"}})}catch(r){console.error("处理购买请求失败:",r),B.ElMessage.error("处理购买请求失败")}finally{i.value=!1}};async function Ft(o,t){let a=e.ref({});const s=e.ref([]),d=[o].map(m=>{var G;const{shopId:g,shopName:I,shopLogo:$,products:E}=m;for(let R=0;R<s.value.length;R++)((G=Object.values(s.value[R]))==null?void 0:G[0])!==""&&(a.value={...a.value,...s.value[R]});return{id:g,name:I,logo:$,remark:a.value||{},products:E.map(({id:R,skuId:X,num:w,productFeaturesValue:u})=>({id:R,skuId:X,num:w,productFeaturesValue:u}))}});d.forEach(m=>{m.products.forEach(g=>{const I=g.productFeaturesValue,$={};I==null||I.forEach(E=>{var G;$[E.id]=(G=E==null?void 0:E.featureValues)==null?void 0:G.map(R=>R.featureValueId)}),g.productFeaturesValue=$})});const c={receiver:t,shopPackages:d,source:"PRODUCT",orderType:"PACKAGE",activity:{activityId:o.activityParam.activityId,extra:o.activityParam.extra},discounts:{},extra:{distributionMode:P.value[0].distributionMode,shopStoreId:"",packUpTime:""},distributionMode:P.value[0].distributionMode};return await Pe({...c})}const Ut=async o=>{const t=Object.keys(o).map(c=>({shopId:h.query.shopId,productId:c,skuId:o[c].id})),a=await Ie(t);if(a.code!==200||!a.data)return B.ElMessage.error(`${a.msg||"获取店铺基本信息失败"}`);const s=a.data;return{mainProduict:s.find(c=>c.productId===h.query.productId),deliveryData:s}},zt=o=>{let t="";return P.value.forEach(a=>{for(let s=0;s<a.setMealProductDetails.length;s++)a.setMealProductDetails[s].setMealProductSkuDetails.forEach(d=>{d.skuId===o&&(t=d.matchingPrice)})}),t},Jt=e.computed(()=>P.value.length>0),ke=o=>{se.value={...se.value,...o}},Se=(o,t,a=!0)=>{a?l.value[o]=t:Reflect.deleteProperty(l.value,o),Lt()},Lt=()=>{let o=0;for(const t in l.value){const{salePrices:a,attributePirce:s,salePrice:d}=l.value[t];o+=Number(a)+Number(s)-Number(d)}L.value=o};return(o,t)=>{const a=e.resolveComponent("ArrowDownBold"),s=e.resolveComponent("el-icon"),d=e.resolveComponent("el-button");return Jt.value?(e.openBlock(),e.createElementBlock("div",ot,[i.value?(e.openBlock(),e.createElementBlock("div",at,t[0]||(t[0]=[e.createElementVNode("div",{class:"loader"},null,-1)]))):e.createCommentVNode("",!0),(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(P.value,(c,r)=>(e.openBlock(),e.createElementBlock("div",{key:r,class:"content"},[e.createElementVNode("div",st,[e.createElementVNode("div",rt,[e.createVNode(Ne,{name:"icon-tianjia",style:{width:"26px",height:"26px","font-weight":"bold","margin-right":"20px"},size:"25px",color:"#666"})]),(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(c.setMealProductDetails,(m,g)=>{var I,$,E,G,R,X,w,u;return e.openBlock(),e.createElementBlock("div",{key:g,style:{display:"flex","justify-content":"space-evenly"},class:e.normalizeClass([(m==null?void 0:m.productAttributes)!=="MATCHING_PRODUCTS"?"one":"else"])},[e.createElementVNode("div",{class:e.normalizeClass(c.setMealType==="FIXED_COMBINATION"||(I=C[r])!=null&&I[g].checkBox?"content__box content__center boxBorder":"content__box content__center")},[e.createElementVNode("div",{class:"content__box--img",onClick:D=>le(m,g,c.setMealType,r,m.productAttributes)},[e.createElementVNode("img",{src:m==null?void 0:m.productPic,alt:"商品图片"},null,8,ct)],8,nt),e.createElementVNode("div",{class:"content__box--tilText",onClick:D=>le(m,g,c.setMealType,r,m.productAttributes)},e.toDisplayString(m==null?void 0:m.productName),9,lt),(E=($=C==null?void 0:C[r])==null?void 0:$[g])!=null&&E.price?(e.openBlock(),e.createElementBlock("div",{key:0,class:"content__box--price colorRed textFw",onClick:D=>le(m,g,c.setMealType,r,m.productAttributes)}," ￥"+e.toDisplayString(e.unref(V)((R=(G=C==null?void 0:C[r])==null?void 0:G[g])==null?void 0:R.price).toFixed(2)),9,it)):e.createCommentVNode("",!0),e.createElementVNode("div",dt,[e.createElementVNode("div",{class:"content__box--sel",onClick:D=>{var q,M;return Bt(g,m,r,c,(M=(q=C==null?void 0:C[r])==null?void 0:q[g])==null?void 0:M.specs)}},[e.createElementVNode("p",null,e.toDisplayString(((w=(X=C==null?void 0:C[r])==null?void 0:X[g])==null?void 0:w.specs)||"请选择规格"),1),e.createVNode(s,null,{default:e.withCtx(()=>[e.createVNode(a)]),_:1})],8,ut),S.value&&O.value===g&&W.value===r?(e.openBlock(),e.createElementBlock("div",pt,[(e.openBlock(),e.createBlock(Xe,{ref_for:!0,ref_key:"GoodSpecRef",ref:re,key:ce.value,"sku-group":ye.value,"current-choose":Array.isArray((u=A.value)==null?void 0:u.specs)?A.value.specs:[],params:oe.value,"img-boolean":!1,onChooseSpec:At,onInitComplete:Tt},null,8,["sku-group","current-choose","params"])),e.createElementVNode("div",ft,[e.createVNode(d,{onClick:Ot},{default:e.withCtx(()=>t[1]||(t[1]=[e.createTextVNode("确定")])),_:1})])])):e.createCommentVNode("",!0)])],2)],2)}),128))]),t[7]||(t[7]=e.createElementVNode("div",{class:"content__plusSign"},[e.createElementVNode("span",{class:"content__equals",style:{"font-weight":"400","font-size":"56px",color:"#c4c4c4"}},"=")],-1)),e.createElementVNode("div",mt,[e.createElementVNode("div",ht,[e.createElementVNode("p",gt,[t[2]||(t[2]=e.createTextVNode(" 已选择 ")),e.createElementVNode("span",xt,e.toDisplayString(c.setMealType==="FIXED_COMBINATION"?c.setMealProductDetails.length:n.value),1),t[3]||(t[3]=e.createTextVNode(" 件商品 "))]),e.createElementVNode("p",yt,[t[4]||(t[4]=e.createTextVNode(" 优惠金额：")),e.createElementVNode("span",_t,"￥"+e.toDisplayString(e.unref(V)(L.value)),1)]),e.createElementVNode("p",kt,[t[5]||(t[5]=e.createTextVNode(" 套餐价：")),e.createElementVNode("span",St,"￥"+e.toDisplayString(Rt(C[r])),1)])]),e.createElementVNode("div",{class:"content__rightBox--btn",onClick:m=>qt(c,r)},"立即购买",8,bt),e.createElementVNode("div",vt,[e.createElementVNode("div",Nt,[t[6]||(t[6]=e.createElementVNode("text",null,"距离结束：",-1)),e.createVNode(tt,{startTime:c.endTime},null,8,["startTime"])])])])]))),128))])):e.createCommentVNode("",!0)}}}),to="";return ne(Vt,[["__scopeId","data-v-c91d9a8a"]])});
