(function(e,w){typeof exports=="object"&&typeof module<"u"?module.exports=w(require("vue"),require("@/apis/http"),require("element-plus"),require("@/composables/useConvert"),require("vue-router"),require("@/components/q-input-number/q-input-number.vue"),require("@/utils/date")):typeof define=="function"&&define.amd?define(["vue","@/apis/http","element-plus","@/composables/useConvert","vue-router","@/components/q-input-number/q-input-number.vue","@/utils/date"],w):(e=typeof globalThis<"u"?globalThis:e||self,e.PlatformAddBargain=w(e.PlatformAddBargainContext.Vue,e.PlatformAddBargainContext.Request,e.PlatformAddBargainContext.ElementPlus,e.PlatformAddBargainContext.UseConvert,e.PlatformAddBargainContext.VueRouter,e.PlatformAddBargainContext.QInputNumber,e.PlatformAddBargainContext.DateUtil))})(this,function(e,w,y,F,Y,z,$){"use strict";var R=document.createElement("style");R.textContent=`@charset "UTF-8";.com[data-v-f885ca01]{display:flex;justify-content:center;align-items:center}.com__pic[data-v-f885ca01]{width:62px;height:62px}.com__name[data-v-f885ca01]{width:113px;font-size:14px;color:#2e99f3;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;overflow:hidden;margin-left:12px}.add[data-v-b0391ffb]{margin-top:30px;overflow:scroll}.add .p16[data-v-b0391ffb]{padding-left:16px;padding-right:16px}.tool[data-v-b0391ffb]{margin-top:auto;align-items:center;position:sticky;bottom:0;padding:15px 0;display:flex;justify-content:center;box-shadow:0 0 10px #d5d5d5;background-color:#fff;z-index:9}.bargaining_amount[data-v-b0391ffb]{position:relative;width:100%}.bargaining_amount__description[data-v-b0391ffb]{position:absolute;top:-35px;right:0;width:480px}.title[data-v-b0391ffb]{font-size:14px;color:#606266;font-weight:700;margin-bottom:40px}.msg[data-v-b0391ffb]{font-size:12px;margin-left:12px;color:#c4c4c4}.use_discount[data-v-b0391ffb]{display:flex;width:100%}.discount_msg[data-v-b0391ffb]{display:inline-block;width:400px;flex:1}.rules[data-v-b0391ffb]{display:flex;margin-top:10px;height:50px}.period-validity[data-v-b0391ffb]{width:300px;display:flex}.text[data-v-b0391ffb]{font-size:14px;color:#333}.goodsData[data-v-b0391ffb]{border:1px solid #ccc}.goods-list[data-v-b0391ffb]{width:90%;margin-top:20px;height:300px;border:1px solid transparent}.goods-list__info[data-v-b0391ffb]{display:flex}.goods-list__goods-list__info-name[data-v-b0391ffb]{display:flex;flex-direction:column;justify-content:space-around;align-items:flex-start;padding:0 16px}.goods-list__goods-list__info-name--name[data-v-b0391ffb]{width:462px;font-size:14px;color:#2e99f3;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.goods-list__goods-list__info-name--price[data-v-b0391ffb]{font-size:14px;text-align:LEFT;color:#f12f22}.goods-list__goods-list__info-name--price[data-v-b0391ffb]:before{content:"￥";font-size:12px;text-align:LEFT;color:#f12f22}.my-header[data-v-b0391ffb]{font-size:16px}.ruleform-date[data-v-b0391ffb]{width:100%;display:flex;align-items:center}.flex[data-v-b0391ffb]{margin-top:10px;height:50px}.flex-item[data-v-b0391ffb]{width:40%}.coupon-rules[data-v-b0391ffb]{height:60px;display:flex;justify-content:center;align-items:center}.nav-button[data-v-b0391ffb]{position:fixed;left:50%;bottom:30px}
`,document.head.appendChild(R);const G="addon-bargain/bargain",H=b=>w.post({url:G,data:b}),j=b=>w.get({url:G+`/${b.shopId}/${b.activityId}`}),J={class:"com"},O={class:"com__name"},K=e.defineComponent({__name:"select-goods-table",props:{productList:{type:Array,default(){return[]}},isEdit:{type:Boolean,default:!1},flatGoodList:{type:Array,default(){return[]}}},setup(b,{expose:T}){const g=b,{divTenThousand:x,mulTenThousand:V}=F(),N=e.ref([]);e.watch(()=>g.productList,a=>{const f=I(a);console.log("flatGoodList",f),N.value=o(f)}),e.watch(()=>g.flatGoodList,a=>{N.value=o(a)});function A(a){return a.skuItem.stockType==="LIMITED"?Number(a.skuItem.skuStock):1/0}function I(a,f){if(!a.length)return[];const d=[];return a.forEach(l=>{l.skuIds.forEach((m,p)=>{d.push({productId:l.productId,productName:l.productName,productPic:l.pic,skuItem:{productId:l.productId,skuId:m,skuName:l.specs[p],skuPrice:l.salePrices[p],skuStock:l.stocks[p],stockType:l.stockTypes[p]},rowTag:0,stock:0,isJoin:!0,floorPrice:.01})})}),d}function o(a,f){let d=0,l=a.length;for(let m=0;m<l;m++){const p=a[m];m===0&&(p.rowTag=1,d=0),m!==0&&(p.productId===a[m-1].productId?(p.rowTag=0,a[d].rowTag=a[d].rowTag+1):(p.rowTag=1,d=m))}return a}const u=({row:a,column:f,rowIndex:d,columnIndex:l})=>{if(l===0)return{rowspan:a.rowTag,colspan:a.rowTag?1:0}};function S(a){return a.stockType==="UNLIMITED"?"不限购":a.skuStock}function C(){return e.toRaw(N.value).filter(f=>f.isJoin).map(f=>{const{productId:d,productPic:l,floorPrice:m,productName:p,stock:E,skuItem:{skuId:s,skuStock:_,skuPrice:c,skuName:t,stockType:n}}=f;return{activityId:"",productId:d,productPic:l,floorPrice:V(m).toString(),productName:p,stock:E,skuId:s,skuStock:+_,skuPrice:c,skuName:t,stockType:n}})}function M(){let a=!0;const f=N.value;if(!f.length)y.ElMessage.warning("请选择商品"),a=!1;else for(let d=0;d<f.length;d++)if(f[d].isJoin&&!f[d].stock){y.ElMessage.warning("商品库存必须大于零"),a=!1;break}return a}return T({getProduct:C,validateProduct:M}),(a,f)=>{const d=e.resolveComponent("el-image"),l=e.resolveComponent("el-table-column"),m=e.resolveComponent("el-input"),p=e.resolveComponent("el-input-number"),E=e.resolveComponent("el-table");return e.openBlock(),e.createBlock(E,{data:N.value,"span-method":u},{default:e.withCtx(()=>[e.createVNode(l,{label:"商品信息",width:"215"},{default:e.withCtx(({row:s})=>[e.createElementVNode("div",J,[e.createVNode(d,{class:"com__pic",src:s.productPic},null,8,["src"]),e.createElementVNode("div",O,e.toDisplayString(s.productName),1)])]),_:1}),e.createVNode(l,{label:"规格"},{default:e.withCtx(({row:s})=>[e.createTextVNode(e.toDisplayString(s.skuItem.skuName),1)]),_:1}),e.createVNode(l,{label:"砍价低价（元）"},{default:e.withCtx(({row:s})=>[e.createElementVNode("div",null,[g.isEdit?(e.openBlock(),e.createBlock(m,{key:0,style:{width:"80px"},disabled:"",placeholder:e.unref(x)(s.floorPrice).toString()},null,8,["placeholder"])):(e.openBlock(),e.createBlock(p,{key:1,modelValue:s.floorPrice,"onUpdate:modelValue":_=>s.floorPrice=_,min:.01,style:{width:"80px"},disabled:g.isEdit,precision:2,max:e.unref(x)(s.skuItem.skuPrice).toNumber(),controls:!1},null,8,["modelValue","onUpdate:modelValue","disabled","max"]))]),e.createElementVNode("div",null,"销售价"+e.toDisplayString(e.unref(x)(s.skuItem.skuPrice)),1)]),_:1}),e.createVNode(l,{label:"砍价库存"},{default:e.withCtx(({row:s})=>[e.createElementVNode("div",null,[e.createVNode(p,{"model-value":+s.stock,min:0,style:{width:"80px"},max:A(s),disabled:g.isEdit,precision:0,controls:!1,"onUpdate:modelValue":_=>s.stock=_},null,8,["model-value","max","disabled","onUpdate:modelValue"])]),e.createElementVNode("div",null,"库存"+e.toDisplayString(S(s.skuItem)),1)]),_:1})]),_:1},8,["data"])}}}),oe="",L=(b,T)=>{const g=b.__vccOpts||b;for(const[x,V]of T)g[x]=V;return g},X=L(K,[["__scopeId","data-v-f885ca01"]]),Q={class:"add"},W={class:"ruleform-date"},Z={class:"use_discount"},v={class:"bargaining_amount"},ee={class:"tool"},te=e.defineComponent({__name:"PlatformAddBargain",setup(b){const T=Y.useRouter(),g=Y.useRoute(),x=new $,V=e.ref(),N=e.reactive({form:{shopId:"",shopName:"",name:"",startTime:"",endTime:"",bargainingPeople:0,bargainValidityPeriod:5,isSelfBargain:!1,stackable:{coupon:!1,vip:!1,full:!1},status:"ILLEGAL_SELL_OFF",helpCutAmount:"FIX_BARGAIN",bargainProducts:[],productNum:0},isEditDisable:!1,fullReductionTime:[],rules:{name:[{required:!0,message:"请输入活动名称",trigger:"blur"}],product:[{required:!0,message:"请选择商品",trigger:["blur","change"]}],startTime:[{required:!0,message:"请选择开始日期",trigger:["blur","change"]},{validator:p,trigger:["blur","change"]}],endTime:[{required:!0,message:"请选择结束日期",trigger:["blur","change"]},{validator:E,trigger:["blur","change"]}]},chooseGoodsPopup:!1}),A=e.ref([]),I=e.ref([]),{form:o,isEditDisable:u,rules:S}=e.toRefs(N),C=e.ref(),M={79111:"砍价商品在相同时间段内已存在",79112:"砍价活动不存在",79113:"当前商品不是砍价商品"};a();async function a(c=g.query){if(c.shopId&&c.activityId){u.value=!0;const{code:t,data:n,msg:i}=await j(c);if(t!==200)return y.ElMessage.error(i||"获取活动详情失败");o.value={...n,shopName:"",bargainProducts:n.bargainActivityProducts,productNum:n.bargainValidityPeriod},o.value.bargainProducts=n.bargainActivityProducts,I.value=f(n.bargainActivityProducts)}}function f(c){return c.map(t=>{const{productId:n,skuPrice:i,productPic:k,productName:q,skuId:h,skuStock:D,stock:P,skuName:U,floorPrice:B,stockType:r}=t;return{floorPrice:B,isJoin:!0,productId:n,productName:q,productPic:k,stock:P,skuItem:{productId:n,skuId:h,skuName:U,skuPrice:i,skuStock:D,stockType:r}}})}const d=async()=>{if(!(!C.value||!await C.value.validate())&&V.value&&V.value.validateProduct()){o.value.bargainProducts=V.value.getProduct(),o.value.productNum=o.value.bargainProducts.length;const{code:t,data:n,msg:i}=await H(o.value);if(t===200)return l();if([79111,79112,79113].includes(t))return y.ElMessage.error(M[t]||"添加活动失败");y.ElMessage.error(i||"添加活动失败")}};function l(){y.ElMessage.success("添加活动成功"),T.push({name:"bargainIndex"})}function m(c){const t=x.getYMD(new Date),n=x.getYMD(c);return t===n?!1:new Date().getTime()>c.getTime()}function p(c,t,n){t?t&&o.value.endTime?_(new Date(o.value.endTime).getTime(),n,"开始日期和结束日期最少间隔5分钟",new Date(t).getTime(),1e3*60*5):_(new Date(t).getTime(),n,"开始日期必须是一个将来的时间",new Date().getTime(),1e3):n(new Error("请选择活动开始日期"))}function E(c,t,n){t?t&&o.value.startTime?_(new Date(t).getTime(),n,"开始日期和结束日期最少间隔5分钟",new Date(o.value.startTime).getTime(),1e3*60*5):_(new Date(t).getTime(),n,"结束日期最少大当前时间5分钟",new Date().getTime()+1e3,1e3*60*5):n(new Error("请选择活动结束日期"))}function s(c,t=new Date().getTime()){const n=c-t;return(i=1e3)=>n>=i}function _(c,t,n,i,k){s(c,i)(k)?t():t(new Error(n))}return(c,t)=>{const n=e.resolveComponent("el-input"),i=e.resolveComponent("el-form-item"),k=e.resolveComponent("el-date-picker"),q=e.resolveComponent("el-input-number"),h=e.resolveComponent("el-radio"),D=e.resolveComponent("el-radio-group"),P=e.resolveComponent("el-checkbox"),U=e.resolveComponent("el-form"),B=e.resolveComponent("el-button");return e.openBlock(),e.createElementBlock(e.Fragment,null,[e.createElementVNode("div",Q,[t[23]||(t[23]=e.createElementVNode("h1",{class:"title p16"},"基本信息",-1)),e.createVNode(U,{ref_key:"ruleFormRef",ref:C,class:"p16",model:e.unref(o),rules:e.unref(S),"label-width":"auto","inline-message":!1,"label-position":"left"},{default:e.withCtx(()=>[e.createVNode(i,{label:"活动名称",prop:"name"},{default:e.withCtx(()=>[e.createVNode(n,{modelValue:e.unref(o).name,"onUpdate:modelValue":t[0]||(t[0]=r=>e.unref(o).name=r),modelModifiers:{trim:!0},style:{width:"551px"},maxlength:"15",placeholder:"活动名称不超过15个字",disabled:e.unref(u)},null,8,["modelValue","disabled"])]),_:1}),e.createVNode(i,{label:"活动日期",required:""},{default:e.withCtx(()=>[e.createElementVNode("div",W,[e.createVNode(i,{prop:"startTime","inline-message":!1},{default:e.withCtx(()=>[e.createVNode(k,{modelValue:e.unref(o).startTime,"onUpdate:modelValue":t[1]||(t[1]=r=>e.unref(o).startTime=r),type:"datetime",disabled:e.unref(u),placeholder:"请选择开始时间","value-format":"YYYY-MM-DD HH:mm:ss",format:"YYYY/MM/DD HH:mm:ss","disabled-date":m},null,8,["modelValue","disabled"]),t[11]||(t[11]=e.createElementVNode("span",{style:{margin:"0 10px"}},"至",-1))]),_:1}),e.createVNode(i,{prop:"endTime","inline-message":!1},{default:e.withCtx(()=>[e.createVNode(k,{modelValue:e.unref(o).endTime,"onUpdate:modelValue":t[2]||(t[2]=r=>e.unref(o).endTime=r),disabled:e.unref(u),type:"datetime",placeholder:"请选择结束时间","value-format":"YYYY-MM-DD HH:mm:ss",format:"YYYY/MM/DD HH:mm:ss","disabled-date":m},null,8,["modelValue","disabled"])]),_:1})])]),_:1}),e.createVNode(i,{label:"砍价到底的人数",prop:"bargainingPeople",required:""},{default:e.withCtx(()=>[e.createVNode(q,{modelValue:e.unref(o).bargainingPeople,"onUpdate:modelValue":t[3]||(t[3]=r=>e.unref(o).bargainingPeople=r),style:{width:"135px"},disabled:e.unref(u),precision:0,controls:!1,min:2},null,8,["modelValue","disabled"]),t[12]||(t[12]=e.createElementVNode("span",{class:"msg"},"砍到底价所需人数",-1))]),_:1}),e.createVNode(i,{label:"砍价有效期",prop:"bargainValidityPeriod",required:""},{default:e.withCtx(()=>[e.createVNode(z,{modelValue:e.unref(o).bargainValidityPeriod,"onUpdate:modelValue":t[4]||(t[4]=r=>e.unref(o).bargainValidityPeriod=r),controls:!1,precision:0,min:5,disabled:e.unref(u)},{append:e.withCtx(()=>t[13]||(t[13]=[e.createTextVNode(" 分钟 ")])),_:1},8,["modelValue","disabled"]),t[14]||(t[14]=e.createElementVNode("span",{class:"msg"},"砍价有效期是指从用户发起砍价到砍价截止的时间",-1))]),_:1}),e.createVNode(i,{label:"是否自我砍价",prop:"fullReductionName"},{default:e.withCtx(()=>[e.createVNode(D,{modelValue:e.unref(o).isSelfBargain,"onUpdate:modelValue":t[5]||(t[5]=r=>e.unref(o).isSelfBargain=r),class:"ml-4",disabled:e.unref(u)},{default:e.withCtx(()=>[e.createVNode(h,{value:!1},{default:e.withCtx(()=>t[15]||(t[15]=[e.createTextVNode("否")])),_:1}),e.createVNode(h,{value:!0},{default:e.withCtx(()=>t[16]||(t[16]=[e.createTextVNode("是")])),_:1})]),_:1},8,["modelValue","disabled"]),t[17]||(t[17]=e.createElementVNode("span",{class:"msg"},"是否用户发起砍价的同时为自己砍1次价",-1))]),_:1}),e.createVNode(i,{label:"优惠叠加"},{default:e.withCtx(()=>[e.createElementVNode("div",Z,[e.createVNode(P,{modelValue:e.unref(o).stackable.vip,"onUpdate:modelValue":t[6]||(t[6]=r=>e.unref(o).stackable.vip=r),label:"会员价",disabled:e.unref(u)},null,8,["modelValue","disabled"]),e.createVNode(P,{modelValue:e.unref(o).stackable.coupon,"onUpdate:modelValue":t[7]||(t[7]=r=>e.unref(o).stackable.coupon=r),label:"优惠券",disabled:e.unref(u)},null,8,["modelValue","disabled"]),e.createVNode(P,{modelValue:e.unref(o).stackable.full,"onUpdate:modelValue":t[8]||(t[8]=r=>e.unref(o).stackable.full=r),label:"满减",disabled:e.unref(u)},null,8,["modelValue","disabled"]),t[18]||(t[18]=e.createElementVNode("div",{class:"msg discount_msg"},[e.createTextVNode(" 优惠叠加可能导致实付金额为 "),e.createElementVNode("strong",{style:{color:"red"}},"0"),e.createTextVNode(" (实付金额 = 活动价 - 会员优惠 - 优惠券优惠 - 满减优惠) ")],-1))])]),_:1}),e.createVNode(i,{label:"单次砍价金额范围",prop:"fullReductionName"},{default:e.withCtx(()=>[e.createElementVNode("div",v,[e.createVNode(D,{modelValue:e.unref(o).helpCutAmount,"onUpdate:modelValue":t[9]||(t[9]=r=>e.unref(o).helpCutAmount=r),class:"ml-4",disabled:e.unref(u)},{default:e.withCtx(()=>[e.createVNode(h,{value:"RANDOM_BARGAIN"},{default:e.withCtx(()=>t[19]||(t[19]=[e.createTextVNode("随机砍价")])),_:1}),e.createVNode(h,{value:"FIX_BARGAIN"},{default:e.withCtx(()=>t[20]||(t[20]=[e.createTextVNode("固定砍价")])),_:1})]),_:1},8,["modelValue","disabled"])]),t[21]||(t[21]=e.createElementVNode("div",null,[e.createElementVNode("p",{class:"msg"},"a.固定砍价 =（原价 - 砍价底价）/砍价人数"),e.createElementVNode("p",{class:"msg"},"b.随机砍价：最低砍价金额 = 1 ，最高砍价金额 = (原价 - 砍价底价) * 100 / 砍价到底人数 * 2 单位：分，最后一人砍完剩余价格")],-1))]),_:1}),e.createVNode(i,{label:"活动商品",required:""},{default:e.withCtx(()=>t[22]||(t[22]=[e.createElementVNode("span",{class:"msg"},"是否参与：SKU的粒度设置商品是否参与活动，是(默认)则参与活动，反则否",-1)])),_:1})]),_:1},8,["model","rules"]),e.createVNode(X,{ref_key:"selectGoodsTableRef",ref:V,class:"f1 p16","product-list":A.value,"is-edit":e.unref(u),"flat-good-list":I.value},null,8,["product-list","is-edit","flat-good-list"])]),e.createElementVNode("div",ee,[e.createVNode(B,{round:"",plain:"",onClick:t[10]||(t[10]=r=>e.unref(T).back())},{default:e.withCtx(()=>t[24]||(t[24]=[e.createTextVNode("返回")])),_:1}),e.unref(u)?e.createCommentVNode("",!0):(e.openBlock(),e.createBlock(B,{key:0,type:"primary",round:"",onClick:d},{default:e.withCtx(()=>t[25]||(t[25]=[e.createTextVNode("保存")])),_:1}))])],64)}}}),ae="";return L(te,[["__scopeId","data-v-b0391ffb"]])});
