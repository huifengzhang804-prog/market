<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.medusa.gruul.addon.live.mp.mapper.AnchorMapper">

    <resultMap id="anchorMap" type="com.medusa.gruul.addon.live.vo.AnchorVO">
        <result property="id" column="id"/>
        <result property="shopId" column="shop_id"/>
        <result property="anchorNickname" column="anchor_nickname"/>
        <result property="anchorSynopsis" column="anchor_synopsis"/>
        <result property="anchorIcon" column="anchor_icon"/>
        <result property="status" column="status"/>
        <result property="gender" column="gender"/>
        <result property="phone" column="phone"/>
        <result property="followCount" column="followCount"/>
        <result property="viewership" column="viewership"/>
        <result property="duration" column="duration"/>
    </resultMap>
    <sql id="anchorSql">
        anchor.id, anchor.shop_id, anchor.phone, anchor.anchor_nickname, anchor.anchor_synopsis, anchor.anchor_icon, anchor.`status`, anchor.`gender`,
        IFNULL(live.duration,0) AS duration, IFNULL(live.likeCount,0)likeCount, IFNULL(follow.followCount,0) followCount, IFNULL(live.viewership,0) viewership
    </sql>

    <select id="anchorPage" resultMap="anchorMap">
        SELECT
        <include refid="anchorSql"/>
        FROM t_anchor anchor
        LEFT JOIN(
        SELECT
        live.anchor_id AS anchorId,
        SUM(IFNULL(extend.duration,0)) AS duration,
        SUM(IFNULL(extend.like_count,0)) AS likeCount,
        SUM(IFNULL(extend.viewership,0)) AS viewership
        FROM
        t_base_live live
        LEFT JOIN t_live_extend extend ON live.id = extend.live_id AND extend.deleted = 0
        WHERE live.deleted = 0 GROUP BY live.anchor_id) live ON live.anchorId = anchor.id
        LEFT JOIN(
        SELECT
        follow.anchor_id AS anchorId, COUNT(follow.id) AS followCount
        FROM
        t_anchor_follow follow
        WHERE follow.deleted = 0
        GROUP BY follow.anchor_id ) follow ON follow.anchorId = anchor.id
        <where>
            anchor.`deleted` = 0
            <if test="anchorParam.id !=null">
                AND anchor.id = #{anchorParam.id}
            </if>
            <if test="anchorParam.anchorNickname!=null and anchorParam.anchorNickname!=''">
                AND anchor.anchor_nickname LIKE CONCAT('%',#{anchorParam.anchorNickname},'%')
            </if>
            <if test="anchorParam.phone !=null and anchorParam.phone !=''">
                AND anchor.phone LIKE CONCAT('%', #{anchorParam.phone},'%')
            </if>
            <if test="anchorParam.shopId!=0">
                AND anchor.shop_id = #{anchorParam.shopId}
            </if>
            <if test="anchorParam.status!=null">
                <choose>
                    <when test="anchorParam.status == @com.medusa.gruul.addon.live.enums.AnchorStatus @NORMAL">
                        AND anchor.`status` =${@com.medusa.gruul.addon.live.enums.AnchorStatus @NORMAL.value}
                    </when>
                    <when test="anchorParam.status == @com.medusa.gruul.addon.live.enums.AnchorStatus @FORBIDDEN">
                        AND anchor.`status` =${@com.medusa.gruul.addon.live.enums.AnchorStatus @FORBIDDEN.value}
                    </when>
                    <when test="anchorParam.status == @com.medusa.gruul.addon.live.enums.AnchorStatus @VIOLATION">
                        AND anchor.`status` =${@com.medusa.gruul.addon.live.enums.AnchorStatus @VIOLATION.value}
                    </when>
                </choose>
            </if>
            ORDER BY anchor.`create_time` DESC
        </where>
    </select>
    <select id="anchorMessage" resultMap="anchorMap">
        SELECT
        <include refid="anchorSql"/>
        FROM t_anchor anchor
        LEFT JOIN(
        SELECT
        live.anchor_id AS anchorId,
        SUM(IFNULL(extend.duration,0)) AS duration,
        SUM(IFNULL(extend.like_count,0)) AS likeCount,
        SUM(IFNULL(extend.viewership,0)) AS viewership
        FROM
        t_base_live live
        LEFT JOIN t_live_extend extend ON live.id = extend.live_id AND extend.deleted = 0
        WHERE live.deleted = 0  GROUP BY live.`anchor_id`) live ON live.anchorId = anchor.id
        LEFT JOIN(
        SELECT
        follow.anchor_id AS anchorId, COUNT(follow.id) AS followCount
        FROM
        t_anchor_follow follow
        WHERE follow.deleted = 0
        GROUP BY follow.anchor_id ) follow ON follow.anchorId = anchor.id
        <where>
            anchor.`user_id` =#{userId} AND anchor.deleted = 0
        </where>
    </select>
</mapper>
