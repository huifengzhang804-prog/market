<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.medusa.gruul.addon.live.mp.mapper.AnchorFollowMapper">
    <resultMap id="followLiveMap" type="com.medusa.gruul.addon.live.vo.FollowLiveVO">
       <result property="liveId" column="liveId"/>
       <result property="shopId" column="shopId"/>
       <result property="shopName" column="shopName"/>
       <result property="shopLogo" column="shopLogo"/>
       <result property="shopType" column="shopType"/>
       <result property="viewership" column="viewership"/>
       <result property="liveTitle" column="liveTitle"/>
       <result property="pic" column="pic"/>
       <result property="pushAddress" column="pushAddress"/>
       <result property="pullAddress" column="pullAddress"/>
        <result property="beginTime" column="beginTime"/>
        <result property="endTime" column="endTime"/>
       <result property="status" column="status"/>
       <result property="isReservation" column="isReservation"/>
    </resultMap>

    <sql id="liveListSql">
    live.id AS liveId,
    live.shop_id AS shopId,
    live.shop_name AS shopName,
    live.shop_logo AS shopLogo,
    live.shop_type AS shopType,
    IFNULL(extend.viewership,0) AS viewership,
    live.live_title AS liveTitle,
    live.pic AS pic,
    live.push_address AS pushAddress,
    live.pull_address AS pullAddress,
    live.`begin_time` AS beginTime,
    live.`end_time` AS endTime,
    live.`status` AS `status`,
    !ISNULL(reservation.id) AS isReservation
    </sql>

<select id="followLiveList" resultMap="followLiveMap">
    SELECT
   <include refid="liveListSql"/>
    FROM
    t_base_live live
    LEFT JOIN t_live_extend extend ON live.id = extend.live_id AND extend.deleted = 0
    LEFT JOIN t_reservation reservation ON reservation.live_id = live.id AND reservation.deleted = 0
    <where>
        EXISTS (
            SELECT
                follow.id
            FROM t_anchor_follow AS follow
            WHERE
                follow.anchor_id = live.anchor_id
              AND
               follow.deleted = 0
              AND
                follow.user_id = #{userId} )
      <choose>
      <when test="followLiveParam.status == @com.medusa.gruul.addon.live.enums.LiveRoomStatus @NOT_STARTED ">
       AND live.`status` = ${@com.medusa.gruul.addon.live.enums.LiveRoomStatus @NOT_STARTED.value}
       AND live.`begin_time` &gt; NOW()
      </when>
      <when test="followLiveParam.status == @com.medusa.gruul.addon.live.enums.LiveRoomStatus @PROCESSING ">
       AND live.`status` = ${@com.medusa.gruul.addon.live.enums.LiveRoomStatus @PROCESSING.value}
      </when>
      </choose>
    AND
        live.deleted = 0
    <if test="followLiveParam.keyword!=null and followLiveParam.keyword!=''">
        AND live.`live_title` LIKE CONCAT('%', #{followLiveParam.keyword}, '%')
    </if>
    ORDER BY
        live.create_time DESC
    </where>
</select>



    <select id="discoverLiveList" resultMap="followLiveMap">
        SELECT
        <include refid="liveListSql"/>
        FROM
        t_base_live live
        LEFT JOIN t_live_extend extend ON live.id = extend.live_id AND extend.deleted = 0
        LEFT JOIN t_reservation reservation ON reservation.live_id = live.id AND reservation.deleted = 0 AND  reservation.user_id = #{userId}
        <where>
            <choose>
                <when test="followLiveParam.status == @com.medusa.gruul.addon.live.enums.LiveRoomStatus @NOT_STARTED ">
                    AND live.`status` = ${@com.medusa.gruul.addon.live.enums.LiveRoomStatus @NOT_STARTED.value}
                    AND live.`begin_time` &gt; NOW()
                </when>
                <when test="followLiveParam.status == @com.medusa.gruul.addon.live.enums.LiveRoomStatus @PROCESSING ">
                    AND live.`status` = ${@com.medusa.gruul.addon.live.enums.LiveRoomStatus @PROCESSING.value}
                </when>
            </choose>
            AND
            live.deleted = 0
            <if test="followLiveParam.keyword !=null and followLiveParam.keyword!=''">
                AND live.`live_title` LIKE CONCAT('%', #{followLiveParam.keyword}, '%')
            </if>
            ORDER BY
            live.create_time DESC
        </where>
    </select>


</mapper>
