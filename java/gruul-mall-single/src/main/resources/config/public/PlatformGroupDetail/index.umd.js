(function(e,N){typeof exports=="object"&&typeof module<"u"?module.exports=N(require("vue"),require("element-plus"),require("@/composables/useConvert"),require("@/apis/good"),require("@/utils/http"),require("decimal.js"),require("vue-router")):typeof define=="function"&&define.amd?define(["vue","element-plus","@/composables/useConvert","@/apis/good","@/utils/http","decimal.js","vue-router"],N):(e=typeof globalThis<"u"?globalThis:e||self,e.PlatformGroupDetail=N(e.PlatformGroupDetailContext.Vue,e.PlatformGroupDetailContext.ElementPlus,e.PlatformGroupDetailContext.UseConvert,e.PlatformGroupDetailContext.GoodAPI,e.PlatformGroupDetailContext.UtilsHttp,e.PlatformGroupDetailContext.Decimal,e.PlatformGroupDetailContext.VueRouter))})(this,function(e,N,O,G,q,de,A){"use strict";var $=document.createElement("style");$.textContent=`@charset "UTF-8";.com[data-v-7f72b499]{display:flex;justify-content:center;align-items:center}.com__pic[data-v-7f72b499]{width:62px;height:62px}.com__name[data-v-7f72b499]{width:113px;font-size:14px;color:#333;margin-left:10px;display:flex;flex-direction:column;align-items:baseline}.com__name--text[data-v-7f72b499]{display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;overflow:hidden}.flex[data-v-7f72b499]{display:flex;justify-content:space-between;align-items:center}.groupForm[data-v-e8fef7e2]{padding:30px 16px 10px;overflow:scroll}.groupForm__title[data-v-e8fef7e2]{font-size:14px;color:#606266;font-weight:700;margin-bottom:30px}.groupForm__stairs[data-v-e8fef7e2]{margin-bottom:16px}.groupForm__stairs--title[data-v-e8fef7e2]{font-size:12px;color:#333;font-weight:700}.groupForm__stairs--input[data-v-e8fef7e2]{margin:0 7px}.groupForm__btn[data-v-e8fef7e2]{width:1010px;position:fixed;left:292px;bottom:10px;height:60px;display:flex;justify-content:center;align-items:center;box-shadow:0 0 10px #d5d5d5;background-color:#fff;z-index:999;margin:0 auto}.tips[data-v-e8fef7e2]{font-size:12px;color:#c4c4c4}.nav-button[data-v-e8fef7e2]{margin-top:auto;align-items:center;position:sticky;bottom:0;padding:15px 0;display:flex;justify-content:center;box-shadow:0 0 10px #d5d5d5;background-color:#fff;z-index:9}
`,document.head.appendChild($);const R={class:"com"},j={class:"com__name"},L={class:"com__name--text",style:{"margin-top":"5px"}},z={class:"flex"},J={key:0},H={class:"dialog-footer"},K=e.defineComponent({__name:"select-good-table",props:{mode:{type:String,default:"COMMON"},users:{type:Array,default(){return[]}},productList:{type:Array,default(){return[]}},isEdit:{type:Boolean,default:!1},flatGoodList:{type:Array,default(){return[]}}},setup(x,{expose:I}){const t=x,{divTenThousand:_,mulTenThousand:T}=O(),b=e.ref([]);e.watch(()=>t.productList,o=>{const a=d(o);if((a==null?void 0:a.length)===0)return N.ElMessage.error("请至少选择一个存在库存的商品");b.value=h(a)},{deep:!0}),e.watch(()=>t.flatGoodList,o=>{b.value=h(o)});function E(o){return o.skuItem.stockType==="LIMITED"?Number(o.skuItem.skuStock):1e5}function u(o){return _(o.skuItem.skuPrice).toNumber()}function d(o,a){if(!o.length)return[];const f=[];return o.forEach(n=>{n.skuIds.forEach((m,r)=>{(n.stocks[r]>0&&n.stockTypes[r]==="LIMITED"||n.stockTypes[r]==="UNLIMITED")&&f.push({productId:n.productId,productName:n.productName,productPic:n.pic,skuItem:{productId:n.productId,skuId:m,skuName:n.specs[r]?n.specs[r]:"",skuPrice:n.salePrices[r],skuStock:n.stocks[r]?n.stocks[r]:"",stockType:n.stockTypes[r]},rowTag:0,stock:+n.stocks[r],prices:[n.salePrices[r]],isJoin:n.stocks[r]>0})})}),f}function h(o,a){let f=0,n=o.length;for(let m=0;m<n;m++){const r=o[m];m===0&&(r.rowTag=1,f=0),m!==0&&(r.productId===o[m-1].productId?(r.rowTag=0,o[f].rowTag=o[f].rowTag+1):(r.rowTag=1,f=m)),r.prices=r.prices.map(C=>+C),r.stock=+r.stock}return o}const c=({row:o,column:a,rowIndex:f,columnIndex:n})=>{if(n===0)return{rowspan:o.rowTag,colspan:o.rowTag?1:0}};function S(o){return o.stockType==="UNLIMITED"?"无限库存":`${"库存"+o.skuStock||0}`}function p(){const o=e.toRaw(b.value),a=[],f=new Map;if(o.length)for(let n=0;n<o.length;n++){if(!o[n].isJoin)continue;const m=o[n],r=m.productId,C={skuId:m.skuItem.skuId,stock:+m.stock,prices:m.prices.map(M=>T(M).toNumber())};if(!f.has(r))f.set(r,a.length),a.push({productId:r,skus:[C]});else{const M=f.get(r);a[M].skus.push(C)}}return a}function y(){let o=!0;const a=b.value;if(!a.length)N.ElMessage.warning("请选择商品"),o=!1;else for(let f=0;f<a.length;f++)if(a[f].isJoin){if(!a[f].stock){N.ElMessage.warning("商品库存必须大于零"),o=!1;break}if(a[f].prices.length!==t.users.length||a[f].prices.some(n=>n===null)){N.ElMessage.warning("拼团价格填写完整"),o=!1;break}}return o}const i=e.ref({stock:1,price:[.01]}),k=e.ref(!1),B=e.ref("0"),g=o=>{B.value=o.productId,i.value.stock=o.skuItem.skuStock,k.value=!0},s=()=>{i.value={stock:1,price:[.01]},k.value=!1},U=()=>{t.mode==="COMMON"?b.value.forEach(o=>{o.productId===B.value&&(o.stock=i.value.stock>E(o)?E(o):i.value.stock,o.prices[0]=i.value.price[0]>u(o)?u(o):i.value.price[0])}):b.value.forEach(o=>{if(o.productId===B.value){o.stock=i.value.stock>E(o)?E(o):i.value.stock;for(let a=0;a<t.users.length;a++)t.users.length[a],o.prices[a]=i.value.price[a]>u(o)?u(o):i.value.price[a]}}),k.value=!1},w=(o,a)=>typeof o=="string"?o:o.length===1?o[0]:o[a];return I({getProduct:p,validateProduct:y}),(o,a)=>{const f=e.resolveComponent("el-image"),n=e.resolveComponent("el-button"),m=e.resolveComponent("el-table-column"),r=e.resolveComponent("el-input-number"),C=e.resolveComponent("el-input"),M=e.resolveComponent("el-switch"),re=e.resolveComponent("el-table"),se=e.resolveComponent("el-dialog");return e.openBlock(),e.createElementBlock(e.Fragment,null,[e.createVNode(re,{data:b.value,"span-method":c},{default:e.withCtx(()=>[e.createVNode(m,{label:"商品信息",width:"215"},{default:e.withCtx(({row:l})=>[e.createElementVNode("div",R,[e.createVNode(f,{src:l.productPic,class:"com__pic"},null,8,["src"]),e.createElementVNode("div",j,[t.isEdit?e.createCommentVNode("",!0):(e.openBlock(),e.createBlock(n,{key:0,class:"com__batch",type:"primary",link:"",onClick:V=>g(l)},{default:e.withCtx(()=>[e.createTextVNode(" 批量设置 ")]),_:2},1032,["onClick"])),e.createElementVNode("span",L,e.toDisplayString(l.productName),1)])])]),_:1}),e.createVNode(m,{label:"规格"},{default:e.withCtx(({row:l,column:V,$index:P})=>[e.createTextVNode(e.toDisplayString(w(l.skuItem.skuName,P)),1)]),_:1}),e.createVNode(m,{label:"库存"},{default:e.withCtx(({row:l,column:V,$index:P})=>[e.createElementVNode("div",null,[e.createVNode(r,{modelValue:l.stock,"onUpdate:modelValue":ne=>l.stock=ne,min:0,style:{width:"80px"},max:E(l),disabled:t.isEdit,precision:0,controls:!1},null,8,["modelValue","onUpdate:modelValue","max","disabled"])]),e.createElementVNode("div",null,e.toDisplayString(S(l.skuItem)),1)]),_:1}),t.mode==="COMMON"?(e.openBlock(),e.createBlock(m,{key:0,label:"拼团价"},{default:e.withCtx(({row:l})=>[e.createElementVNode("div",null,[t.isEdit?(e.openBlock(),e.createBlock(C,{key:0,style:{width:"80px"},disabled:"",placeholder:e.unref(_)(l.prices[0]).toString()},null,8,["placeholder"])):(e.openBlock(),e.createBlock(r,{key:1,modelValue:l.prices[0],"onUpdate:modelValue":V=>l.prices[0]=V,min:.01,style:{width:"80px"},disabled:t.isEdit,precision:2,max:u(l),controls:!1},null,8,["modelValue","onUpdate:modelValue","disabled","max"]))]),e.createElementVNode("div",null,"销售价"+e.toDisplayString(e.unref(_)(l.skuItem.skuPrice)),1)]),_:1})):e.createCommentVNode("",!0),t.mode==="STAIRS"&&t.users.length>0?(e.openBlock(),e.createBlock(m,{key:1,label:"第一阶段拼团"},{default:e.withCtx(({row:l})=>[e.createElementVNode("div",null,[t.isEdit?(e.openBlock(),e.createBlock(C,{key:0,style:{width:"80px"},disabled:"",placeholder:e.unref(_)(l.prices[0]).toString()},null,8,["placeholder"])):(e.openBlock(),e.createBlock(r,{key:1,modelValue:l.prices[0],"onUpdate:modelValue":V=>l.prices[0]=V,min:.01,style:{width:"80px"},disabled:t.isEdit,precision:2,max:u(l),controls:!1},null,8,["modelValue","onUpdate:modelValue","disabled","max"]))]),e.createElementVNode("div",null,"销售价"+e.toDisplayString(e.unref(_)(l.skuItem.skuPrice)),1)]),_:1})):e.createCommentVNode("",!0),t.mode==="STAIRS"&&t.users.length>1?(e.openBlock(),e.createBlock(m,{key:2,label:"第二阶段拼团"},{default:e.withCtx(({row:l})=>[e.createElementVNode("div",null,[t.isEdit?(e.openBlock(),e.createBlock(C,{key:0,style:{width:"80px"},disabled:"",placeholder:e.unref(_)(l.prices[1]).toString()},null,8,["placeholder"])):(e.openBlock(),e.createBlock(r,{key:1,modelValue:l.prices[1],"onUpdate:modelValue":V=>l.prices[1]=V,disabled:t.isEdit,min:.01,style:{width:"80px"},max:u(l),precision:2,controls:!1},null,8,["modelValue","onUpdate:modelValue","disabled","max"]))]),e.createElementVNode("div",null,"销售价"+e.toDisplayString(u(l)),1)]),_:1})):e.createCommentVNode("",!0),t.mode==="STAIRS"&&t.users.length>2?(e.openBlock(),e.createBlock(m,{key:3,label:"第三阶段拼团"},{default:e.withCtx(({row:l})=>[e.createElementVNode("div",null,[t.isEdit?(e.openBlock(),e.createBlock(C,{key:0,style:{width:"80px"},disabled:"",placeholder:e.unref(_)(l.prices[2]).toString()},null,8,["placeholder"])):(e.openBlock(),e.createBlock(r,{key:1,modelValue:l.prices[2],"onUpdate:modelValue":V=>l.prices[2]=V,disabled:t.isEdit,min:.01,style:{width:"80px"},precision:2,max:u(l),controls:!1},null,8,["modelValue","onUpdate:modelValue","disabled","max"]))]),e.createElementVNode("div",null,"销售价"+e.toDisplayString(u(l)),1)]),_:1})):e.createCommentVNode("",!0),e.createVNode(m,{label:"是否参与"},{default:e.withCtx(({row:l})=>[e.createVNode(M,{modelValue:l.isJoin,"onUpdate:modelValue":V=>l.isJoin=V,size:"large",disabled:t.isEdit},null,8,["modelValue","onUpdate:modelValue","disabled"])]),_:1})]),_:1},8,["data"]),e.createVNode(se,{modelValue:k.value,"onUpdate:modelValue":a[3]||(a[3]=l=>k.value=l),title:"批量设置","destroy-on-close":"",center:"",width:t.mode==="COMMON"?500:"50%",top:"30vh",onClose:s},{footer:e.withCtx(()=>[e.createElementVNode("div",H,[e.createVNode(n,{onClick:a[2]||(a[2]=l=>k.value=!1)},{default:e.withCtx(()=>[e.createTextVNode("取消")]),_:1}),e.createVNode(n,{type:"primary",onClick:U},{default:e.withCtx(()=>[e.createTextVNode(" 确定 ")]),_:1})])]),default:e.withCtx(()=>[e.createElementVNode("div",z,[e.createElementVNode("div",null,[e.createTextVNode(" 库存 "),e.createVNode(r,{modelValue:i.value.stock,"onUpdate:modelValue":a[0]||(a[0]=l=>i.value.stock=l),controls:!1,style:e.normalizeStyle({width:t.mode==="COMMON"?"150px":"80px"}),min:0,precision:0},null,8,["modelValue","style"])]),t.mode==="COMMON"?(e.openBlock(),e.createElementBlock("div",J,[e.createTextVNode(" 拼团价 "),e.createVNode(r,{modelValue:i.value.price[0],"onUpdate:modelValue":a[1]||(a[1]=l=>i.value.price[0]=l),precision:2,controls:!1,min:.01},null,8,["modelValue"])])):(e.openBlock(!0),e.createElementBlock(e.Fragment,{key:1},e.renderList(t.users,(l,V)=>(e.openBlock(),e.createElementBlock("div",{key:V},[e.createTextVNode(" 第"+e.toDisplayString(V+1)+"阶段拼团 ",1),e.createVNode(r,{modelValue:i.value.price[V],"onUpdate:modelValue":P=>i.value.price[V]=P,style:{width:"80px"},precision:2,controls:!1,min:.01},null,8,["modelValue","onUpdate:modelValue"])]))),128))])]),_:1},8,["modelValue","width"])],64)}}}),ce="",F=(x,I)=>{const t=x.__vccOpts||x;for(const[_,T]of I)t[_]=T;return t},Q=F(K,[["__scopeId","data-v-7f72b499"]]),W=(x,I)=>q.http.get({url:`addon-team/team/activity/${I}`,params:{shopId:x}}),D=x=>(e.pushScopeId("data-v-e8fef7e2"),x=x(),e.popScopeId(),x),X={class:"groupForm"},Y=D(()=>e.createElementVNode("div",{class:"groupForm__title"},"基本信息",-1)),Z={key:1},v={class:"groupForm__stairs--title"},ee=D(()=>e.createElementVNode("span",{class:"tips",style:{"margin-left":"8px"}},"商品按下单减库存，请设置未付款订单自动取消时间及时释放库存，可输入3-360分钟",-1)),te=D(()=>e.createElementVNode("div",{class:"tips"}," 开启模拟成团后，拼团有效期内人数未满的团，系统将会以“虚拟用户”凑满人数，使该团拼团成功。你只需要对已付款参团的真实买家发货。建议合理开启，以提高成团率。 ",-1)),oe=D(()=>e.createElementVNode("div",{class:"tips"},"开启凑团后，活动商品详情页展示未成团的团列表，买家可以任选一个团参团，提升成团率。",-1)),le={class:"nav-button"},ae=e.defineComponent({__name:"PlatformGroupDetail",setup(x){const I=A.useRoute(),t=e.ref({name:"",startTime:"",endTime:"",effectTimeout:0,mode:"COMMON",users:[],payTimeout:0,simulate:!1,huddle:!1,stackable:{vip:!1,coupon:!1,full:!1},products:[]}),_=e.ref([]),T=e.ref([]);b();async function b(){const u=I.query.activityId,d=I.query.shopId,{code:h,data:c}=await W(d,u);if(h!==200)return N.ElMessage.error("获取表单失败");t.value=c,T.value=[c.startTime,c.endTime],E(c)}async function E(u){const d=u.products.map(p=>p.productId),{code:h,data:c}=await G.doGetRetrieveProduct({productId:d});if(h!==200)return N.ElMessage.error("获取活动商品信息失败");const S=[];if(c.list.length)for(let p=0;p<u.products.length;p++){const y=c.list.findIndex(i=>i.productId===u.products[p].productId);for(let i=0;i<u.products[y].skus.length;i++){let k={productName:c.list[p].productName,productPic:c.list[p].pic,productId:c.list[p].productId,skuItem:{productId:c.list[p].productId,skuId:"",skuName:"",skuPrice:"",skuStock:"",stockType:"LIMITED"},rowTag:0,stock:0,prices:[],isJoin:!0};const B=u.products[y].skus[i].skuId,g=c.list[p].skuIds.findIndex(s=>s===B);k.skuItem.skuId=c.list[p].skuIds[g],k.skuItem.skuName=c.list[p].specs[g],k.skuItem.skuPrice=c.list[p].salePrices[g],k.skuItem.skuStock=c.list[p].stocks[g],k.skuItem.stockType=c.list[p].stockTypes[g],k.stock=u.products[y].skus[i].stock,k.prices=u.products[y].skus[i].prices,S.push(k)}}_.value=S}return(u,d)=>{const h=e.resolveComponent("el-input"),c=e.resolveComponent("el-form-item"),S=e.resolveComponent("el-date-picker"),p=e.resolveComponent("el-radio"),y=e.resolveComponent("el-radio-group"),i=e.resolveComponent("el-input-number"),k=e.resolveComponent("el-checkbox"),B=e.resolveComponent("el-form"),g=e.resolveComponent("el-button");return e.openBlock(),e.createElementBlock(e.Fragment,null,[e.createElementVNode("div",X,[Y,e.createVNode(B,{ref:"ruleFormRef",model:t.value,"label-width":"110","label-position":"right",disabled:""},{default:e.withCtx(()=>[e.createVNode(c,{label:"活动名称",prop:"name"},{default:e.withCtx(()=>[e.createVNode(h,{modelValue:t.value.name,"onUpdate:modelValue":d[0]||(d[0]=s=>t.value.name=s),placeholder:"限10字",style:{width:"550px"},maxlength:"10"},null,8,["modelValue"])]),_:1}),e.createVNode(c,{label:"活动时间",prop:"startTime"},{default:e.withCtx(()=>[e.createElementVNode("div",null,[e.createVNode(S,{modelValue:T.value,"onUpdate:modelValue":d[1]||(d[1]=s=>T.value=s),style:{width:"550px"},type:"datetimerange","range-separator":"-","start-placeholder":"开始时间","end-placeholder":"结束时间"},null,8,["modelValue"])])]),_:1}),e.createVNode(c,{label:"拼团有效时间",prop:"effectTimeout",required:""},{default:e.withCtx(()=>[e.createVNode(h,{modelValue:t.value.effectTimeout,"onUpdate:modelValue":d[2]||(d[2]=s=>t.value.effectTimeout=s),formatter:s=>Number(`${s}`.replace(/[^\d]/g,"")),style:{width:"550px"}},{append:e.withCtx(()=>[e.createTextVNode(" 分钟 ")]),_:1},8,["modelValue","formatter"])]),_:1}),e.createVNode(c,{label:"拼团模式",prop:"mode"},{default:e.withCtx(()=>[e.createVNode(y,{modelValue:t.value.mode,"onUpdate:modelValue":d[3]||(d[3]=s=>t.value.mode=s)},{default:e.withCtx(()=>[e.createVNode(p,{value:"COMMON"},{default:e.withCtx(()=>[e.createTextVNode("普通拼团")]),_:1}),e.createVNode(p,{value:"STAIRS"},{default:e.withCtx(()=>[e.createTextVNode("阶梯拼团")]),_:1})]),_:1},8,["modelValue"])]),_:1}),e.createVNode(c,{label:"参团人数",prop:"users",required:""},{default:e.withCtx(()=>[t.value.mode==="COMMON"?(e.openBlock(),e.createBlock(h,{key:0,modelValue:t.value.users[0],"onUpdate:modelValue":d[4]||(d[4]=s=>t.value.users[0]=s),formatter:s=>Number(`${s}`.replace(/[^\d]/g,"")),parser:s=>`$ ${Number(s)>=100?100:s}`,style:{width:"550px"},max:100},{append:e.withCtx(()=>[e.createTextVNode(" 人 ")]),_:1},8,["modelValue","formatter","parser"])):(e.openBlock(),e.createElementBlock("div",Z,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(t.value.users,(s,U)=>(e.openBlock(),e.createElementBlock("div",{key:U,class:"groupForm__stairs"},[e.createElementVNode("span",v,"第"+e.toDisplayString(U+1)+"阶段人数",1),e.createVNode(h,{modelValue:t.value.users[U],"onUpdate:modelValue":w=>t.value.users[U]=w,class:"groupForm__stairs--input",style:{width:"450px"},formatter:w=>Number(`${w}`.replace(/[^\d]/g,"")),parser:w=>`${Number(w)>=100?100:w}`,max:100},{append:e.withCtx(()=>[e.createTextVNode(" 人 ")]),_:2},1032,["modelValue","onUpdate:modelValue","formatter","parser"])]))),128))]))]),_:1}),e.createVNode(c,{label:"订单关闭时间",prop:"payTimeout"},{default:e.withCtx(()=>[e.createVNode(i,{modelValue:t.value.payTimeout,"onUpdate:modelValue":d[5]||(d[5]=s=>t.value.payTimeout=s),controls:!1,max:360,min:3},null,8,["modelValue"]),ee]),_:1}),e.createVNode(c,{label:"模拟成团",prop:"simulate"},{default:e.withCtx(()=>[e.createElementVNode("div",null,[e.createVNode(y,{modelValue:t.value.simulate,"onUpdate:modelValue":d[6]||(d[6]=s=>t.value.simulate=s)},{default:e.withCtx(()=>[e.createVNode(p,{value:!1},{default:e.withCtx(()=>[e.createTextVNode("关闭")]),_:1}),e.createVNode(p,{value:!0},{default:e.withCtx(()=>[e.createTextVNode("开启")]),_:1})]),_:1},8,["modelValue"]),te])]),_:1}),e.createVNode(c,{label:"凑团模式",prop:"huddle"},{default:e.withCtx(()=>[e.createElementVNode("div",null,[e.createVNode(y,{modelValue:t.value.huddle,"onUpdate:modelValue":d[7]||(d[7]=s=>t.value.huddle=s)},{default:e.withCtx(()=>[e.createVNode(p,{value:!1},{default:e.withCtx(()=>[e.createTextVNode("关闭")]),_:1}),e.createVNode(p,{value:!0},{default:e.withCtx(()=>[e.createTextVNode("开启")]),_:1})]),_:1},8,["modelValue"]),oe])]),_:1}),e.createVNode(c,{label:"优惠叠加"},{default:e.withCtx(()=>[e.createVNode(k,{modelValue:t.value.stackable.vip,"onUpdate:modelValue":d[8]||(d[8]=s=>t.value.stackable.vip=s),label:"会员价"},null,8,["modelValue"]),e.createVNode(k,{modelValue:t.value.stackable.coupon,"onUpdate:modelValue":d[9]||(d[9]=s=>t.value.stackable.coupon=s),label:"优惠券"},null,8,["modelValue"]),e.createVNode(k,{modelValue:t.value.stackable.full,"onUpdate:modelValue":d[10]||(d[10]=s=>t.value.stackable.full=s),label:"满减"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"]),e.createVNode(Q,{ref:"selectGoodsTableRef",mode:t.value.mode,users:t.value.users,"is-edit":!0,"flat-good-list":_.value},null,8,["mode","users","flat-good-list"])]),e.createElementVNode("div",le,[e.createVNode(g,{round:"",plain:"",onClick:d[11]||(d[11]=s=>u.$router.back())},{default:e.withCtx(()=>[e.createTextVNode("返回")]),_:1})])],64)}}}),ie="";return F(ae,[["__scopeId","data-v-e8fef7e2"]])});
