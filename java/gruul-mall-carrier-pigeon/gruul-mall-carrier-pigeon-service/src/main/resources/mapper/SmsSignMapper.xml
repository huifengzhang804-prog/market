<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.medusa.gruul.carrier.pigeon.service.modules.sms.mp.mapper.SmsSignMapper">

    <resultMap id="BaseDtoResultMap" type="com.medusa.gruul.carrier.pigeon.service.modules.sms.model.dto.EditSmsConfigDto">
        <result column="smsSignId" property="smsSignId"/>
        <result column="type" property="type"/>
        <result column="appId" property="providerAppId"/>
        <result column="appSecret" property="providerAppSecret"/>
        <result column="signature" property="signature"/>
        <result column="templateCode" property="templateCode"/>
        <result column="smsTemplateId" property="templateId"/>
    </resultMap>


    <select id="getConf" resultMap="BaseDtoResultMap">
    SELECT
        smsSign.id AS smsSignId,
        smsSign.type AS type,
        smsSign.provider_app_id AS appId,
        smsSign.provider_app_secret AS appSecret,
        smsSign.signature AS signature,
        smsTemplate.template_code AS templateCode,
        smsTemplate.id AS smsTemplateId
        FROM
            t_sms_sign AS smsSign
        INNER JOIN t_sms_template AS smsTemplate on smsSign.id = smsTemplate.sms_sign_id
        WHERE
        smsTemplate.type = #{template.value}
          <if test="platform != null">
              AND smsSign.type = #{platform.value}
          </if>
        AND smsSign.deleted = 0 
        AND smsTemplate.deleted=0
        ORDER BY RAND()
        LIMIT 1
    </select>
</mapper>